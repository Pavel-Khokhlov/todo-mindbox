{"version":3,"file":"index.js","names":["path","transform","debug","getCacheInstance","outputCssLoader","require","resolve","webpack5Loader","webpack5LoaderPlugin","content","inputSourceMap","convertSourceMap","value","filename","undefined","file","mappings","names","sources","version","async","resourcePath","sourceMap","preprocessor","extension","cacheProvider","rest","getOptions","outputFileName","replace","asyncResolve","token","importer","context","isAbsolute","dirname","join","process","cwd","Promise","reject","err","result","addDependency","Error","toString","relative","pluginOptions","then","cssText","Buffer","from","cssSourceMapText","all","dependencies","map","dep","cacheInstance","set","request","encodeURIComponent","stringifiedRequest","JSON","stringify","utils","contextify","rootContext","callback","code","catch"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Webpack loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\n\nimport type { RawSourceMap } from 'source-map';\nimport type { RawLoaderDefinitionFunction } from 'webpack';\n\nimport type { Result, Preprocessor } from '@linaria/babel-preset';\nimport { transform } from '@linaria/babel-preset';\nimport { debug } from '@linaria/logger';\n\nimport type { ICache } from './cache';\nimport { getCacheInstance } from './cache';\n\nconst outputCssLoader = require.resolve('./outputCssLoader');\n\ntype Loader = RawLoaderDefinitionFunction<{\n  sourceMap?: boolean;\n  preprocessor?: Preprocessor;\n  extension?: string;\n  cacheProvider?: string | ICache;\n}>;\n\nconst webpack5Loader: Loader = function webpack5LoaderPlugin(\n  content,\n  inputSourceMap\n) {\n  function convertSourceMap(\n    value: typeof inputSourceMap,\n    filename: string\n  ): RawSourceMap | undefined {\n    if (typeof value === 'string' || !value) {\n      return undefined;\n    }\n\n    return {\n      ...value,\n      file: value.file ?? filename,\n      mappings: value.mappings ?? '',\n      names: value.names ?? [],\n      sources: value.sources ?? [],\n      version: value.version ?? 3,\n    };\n  }\n\n  // tell Webpack this loader is async\n  this.async();\n\n  debug('loader', this.resourcePath);\n\n  const {\n    sourceMap = undefined,\n    preprocessor = undefined,\n    extension = '.linaria.css',\n    cacheProvider,\n    ...rest\n  } = this.getOptions() || {};\n\n  const outputFileName = this.resourcePath.replace(/\\.[^.]+$/, extension);\n\n  const asyncResolve = (token: string, importer: string): Promise<string> => {\n    const context = path.isAbsolute(importer)\n      ? path.dirname(importer)\n      : path.join(process.cwd(), path.dirname(importer));\n    return new Promise((resolve, reject) => {\n      this.resolve(context, token, (err, result) => {\n        if (err) {\n          reject(err);\n        } else if (result) {\n          this.addDependency(result);\n          resolve(result);\n        } else {\n          reject(new Error(`Cannot resolve ${token}`));\n        }\n      });\n    });\n  };\n\n  transform(\n    content.toString(),\n    {\n      filename: path.relative(process.cwd(), this.resourcePath),\n      inputSourceMap: convertSourceMap(inputSourceMap, this.resourcePath),\n      pluginOptions: rest,\n      preprocessor,\n    },\n    asyncResolve\n  ).then(\n    async (result: Result) => {\n      if (result.cssText) {\n        let { cssText } = result;\n\n        if (sourceMap) {\n          cssText += `/*# sourceMappingURL=data:application/json;base64,${Buffer.from(\n            result.cssSourceMapText || ''\n          ).toString('base64')}*/`;\n        }\n\n        await Promise.all(\n          result.dependencies?.map((dep) =>\n            asyncResolve(dep, this.resourcePath)\n          ) ?? []\n        );\n\n        getCacheInstance(cacheProvider)\n          .then((cacheInstance) =>\n            cacheInstance.set(this.resourcePath, cssText)\n          )\n          .then(() => {\n            const request = `${outputFileName}!=!${outputCssLoader}?cacheProvider=${encodeURIComponent(\n              typeof cacheProvider === 'string' ? cacheProvider : ''\n            )}!${this.resourcePath}`;\n            const stringifiedRequest = JSON.stringify(\n              this.utils.contextify(this.context || this.rootContext, request)\n            );\n\n            return this.callback(\n              null,\n              `${result.code}\\n\\nrequire(${stringifiedRequest});`,\n              result.sourceMap ?? undefined\n            );\n          })\n          .catch((err: Error) => this.callback(err));\n        return;\n      }\n\n      this.callback(null, result.code, result.sourceMap ?? undefined);\n    },\n    (err: Error) => this.callback(err)\n  );\n};\n\nexport default webpack5Loader;\n"],"mappings":"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"}