{"version":3,"file":"index.js","names":["outputCssLoader","require","resolve","webpack5Loader","webpack5LoaderPlugin","content","inputSourceMap","convertSourceMap","value","filename","undefined","file","mappings","names","sources","version","async","debug","resourcePath","sourceMap","preprocessor","extension","cacheProvider","rest","getOptions","outputFileName","replace","asyncResolve","token","importer","context","path","isAbsolute","dirname","join","process","cwd","Promise","reject","err","result","addDependency","Error","transform","toString","relative","pluginOptions","then","cssText","Buffer","from","cssSourceMapText","all","dependencies","map","dep","getCacheInstance","cacheInstance","set","request","encodeURIComponent","stringifiedRequest","JSON","stringify","utils","contextify","rootContext","callback","code","catch"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Webpack loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\n\nimport type { RawSourceMap } from 'source-map';\nimport type { RawLoaderDefinitionFunction } from 'webpack';\n\nimport type { Result, Preprocessor } from '@linaria/babel-preset';\nimport { transform } from '@linaria/babel-preset';\nimport { debug } from '@linaria/logger';\n\nimport type { ICache } from './cache';\nimport { getCacheInstance } from './cache';\n\nconst outputCssLoader = require.resolve('./outputCssLoader');\n\ntype Loader = RawLoaderDefinitionFunction<{\n  sourceMap?: boolean;\n  preprocessor?: Preprocessor;\n  extension?: string;\n  cacheProvider?: string | ICache;\n}>;\n\nconst webpack5Loader: Loader = function webpack5LoaderPlugin(\n  content,\n  inputSourceMap\n) {\n  function convertSourceMap(\n    value: typeof inputSourceMap,\n    filename: string\n  ): RawSourceMap | undefined {\n    if (typeof value === 'string' || !value) {\n      return undefined;\n    }\n\n    return {\n      ...value,\n      file: value.file ?? filename,\n      mappings: value.mappings ?? '',\n      names: value.names ?? [],\n      sources: value.sources ?? [],\n      version: value.version ?? 3,\n    };\n  }\n\n  // tell Webpack this loader is async\n  this.async();\n\n  debug('loader', this.resourcePath);\n\n  const {\n    sourceMap = undefined,\n    preprocessor = undefined,\n    extension = '.linaria.css',\n    cacheProvider,\n    ...rest\n  } = this.getOptions() || {};\n\n  const outputFileName = this.resourcePath.replace(/\\.[^.]+$/, extension);\n\n  const asyncResolve = (token: string, importer: string): Promise<string> => {\n    const context = path.isAbsolute(importer)\n      ? path.dirname(importer)\n      : path.join(process.cwd(), path.dirname(importer));\n    return new Promise((resolve, reject) => {\n      this.resolve(context, token, (err, result) => {\n        if (err) {\n          reject(err);\n        } else if (result) {\n          this.addDependency(result);\n          resolve(result);\n        } else {\n          reject(new Error(`Cannot resolve ${token}`));\n        }\n      });\n    });\n  };\n\n  transform(\n    content.toString(),\n    {\n      filename: path.relative(process.cwd(), this.resourcePath),\n      inputSourceMap: convertSourceMap(inputSourceMap, this.resourcePath),\n      pluginOptions: rest,\n      preprocessor,\n    },\n    asyncResolve\n  ).then(\n    async (result: Result) => {\n      if (result.cssText) {\n        let { cssText } = result;\n\n        if (sourceMap) {\n          cssText += `/*# sourceMappingURL=data:application/json;base64,${Buffer.from(\n            result.cssSourceMapText || ''\n          ).toString('base64')}*/`;\n        }\n\n        await Promise.all(\n          result.dependencies?.map((dep) =>\n            asyncResolve(dep, this.resourcePath)\n          ) ?? []\n        );\n\n        getCacheInstance(cacheProvider)\n          .then((cacheInstance) =>\n            cacheInstance.set(this.resourcePath, cssText)\n          )\n          .then(() => {\n            const request = `${outputFileName}!=!${outputCssLoader}?cacheProvider=${encodeURIComponent(\n              typeof cacheProvider === 'string' ? cacheProvider : ''\n            )}!${this.resourcePath}`;\n            const stringifiedRequest = JSON.stringify(\n              this.utils.contextify(this.context || this.rootContext, request)\n            );\n\n            return this.callback(\n              null,\n              `${result.code}\\n\\nrequire(${stringifiedRequest});`,\n              result.sourceMap ?? undefined\n            );\n          })\n          .catch((err: Error) => this.callback(err));\n        return;\n      }\n\n      this.callback(null, result.code, result.sourceMap ?? undefined);\n    },\n    (err: Error) => this.callback(err)\n  );\n};\n\nexport default webpack5Loader;\n"],"mappings":"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"}