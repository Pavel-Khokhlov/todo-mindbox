{"version":3,"file":"index.js","names":["transformSync","buildOptions","loadBabelOptions","hasShakerMetadata","default","shakerPlugin","configCache","Map","getShakerConfig","only","sortedOnly","sort","key","join","has","get","config","ast","caller","name","envName","targets","node","esmodules","plugins","require","resolve","onlyExports","set","shaker","filename","options","text","transformOptions","babelOptions","transformed","metadata","Error","code","__linariaShaker","imports"],"sources":["../src/index.ts"],"sourcesContent":["import type { TransformOptions } from '@babel/core';\nimport { transformSync } from '@babel/core';\n\nimport { buildOptions, loadBabelOptions } from '@linaria/utils';\nimport type { Evaluator } from '@linaria/utils';\n\nimport { hasShakerMetadata } from './plugins/shaker-plugin';\n\nexport { default as shakerPlugin } from './plugins/shaker-plugin';\n\nconst configCache = new Map<string, TransformOptions>();\nconst getShakerConfig = (only: string[] | null): TransformOptions => {\n  const sortedOnly = [...(only ?? [])];\n  sortedOnly.sort();\n  const key = sortedOnly.join('\\0');\n  if (configCache.has(key)) {\n    return configCache.get(key)!;\n  }\n\n  const config = {\n    ast: true,\n    caller: {\n      name: 'linaria',\n    },\n    envName: 'linaria',\n    targets: {\n      node: 'current',\n      esmodules: false,\n    },\n    plugins: [\n      [\n        require.resolve('./plugins/shaker-plugin'),\n        {\n          onlyExports: sortedOnly,\n        },\n      ],\n      require.resolve('@babel/plugin-transform-modules-commonjs'),\n    ],\n  };\n\n  configCache.set(key, config);\n  return config;\n};\n\nconst shaker: Evaluator = (filename, options, text, only = null) => {\n  const transformOptions = loadBabelOptions(\n    filename,\n    buildOptions(options?.babelOptions, getShakerConfig(only))\n  );\n\n  const transformed = transformSync(text, {\n    ...transformOptions,\n    filename,\n  });\n\n  if (!transformed || !hasShakerMetadata(transformed.metadata)) {\n    throw new Error(`${filename} has no shaker metadata`);\n  }\n\n  return [transformed.code ?? '', transformed.metadata.__linariaShaker.imports];\n};\n\nexport default shaker;\n"],"mappings":"AACA,SAASA,aAAT,QAA8B,aAA9B;AAEA,SAASC,YAAT,EAAuBC,gBAAvB,QAA+C,gBAA/C;AAGA,SAASC,iBAAT,QAAkC,yBAAlC;AAEA,SAASC,OAAO,IAAIC,YAApB,QAAwC,yBAAxC;AAEA,MAAMC,WAAW,GAAG,IAAIC,GAAJ,EAApB;;AACA,MAAMC,eAAe,GAAIC,IAAD,IAA6C;EACnE,MAAMC,UAAU,GAAG,CAAC,IAAID,IAAI,IAAI,EAAZ,CAAD,CAAnB;EACAC,UAAU,CAACC,IAAX;EACA,MAAMC,GAAG,GAAGF,UAAU,CAACG,IAAX,CAAgB,IAAhB,CAAZ;;EACA,IAAIP,WAAW,CAACQ,GAAZ,CAAgBF,GAAhB,CAAJ,EAA0B;IACxB,OAAON,WAAW,CAACS,GAAZ,CAAgBH,GAAhB,CAAP;EACD;;EAED,MAAMI,MAAM,GAAG;IACbC,GAAG,EAAE,IADQ;IAEbC,MAAM,EAAE;MACNC,IAAI,EAAE;IADA,CAFK;IAKbC,OAAO,EAAE,SALI;IAMbC,OAAO,EAAE;MACPC,IAAI,EAAE,SADC;MAEPC,SAAS,EAAE;IAFJ,CANI;IAUbC,OAAO,EAAE,CACP,CACEC,OAAO,CAACC,OAAR,CAAgB,yBAAhB,CADF,EAEE;MACEC,WAAW,EAAEjB;IADf,CAFF,CADO,EAOPe,OAAO,CAACC,OAAR,CAAgB,0CAAhB,CAPO;EAVI,CAAf;EAqBApB,WAAW,CAACsB,GAAZ,CAAgBhB,GAAhB,EAAqBI,MAArB;EACA,OAAOA,MAAP;AACD,CA/BD;;AAiCA,MAAMa,MAAiB,GAAG,CAACC,QAAD,EAAWC,OAAX,EAAoBC,IAApB,EAA0BvB,IAAI,GAAG,IAAjC,KAA0C;EAClE,MAAMwB,gBAAgB,GAAG/B,gBAAgB,CACvC4B,QADuC,EAEvC7B,YAAY,CAAC8B,OAAO,EAAEG,YAAV,EAAwB1B,eAAe,CAACC,IAAD,CAAvC,CAF2B,CAAzC;EAKA,MAAM0B,WAAW,GAAGnC,aAAa,CAACgC,IAAD,EAAO,EACtC,GAAGC,gBADmC;IAEtCH;EAFsC,CAAP,CAAjC;;EAKA,IAAI,CAACK,WAAD,IAAgB,CAAChC,iBAAiB,CAACgC,WAAW,CAACC,QAAb,CAAtC,EAA8D;IAC5D,MAAM,IAAIC,KAAJ,CAAW,GAAEP,QAAS,yBAAtB,CAAN;EACD;;EAED,OAAO,CAACK,WAAW,CAACG,IAAZ,IAAoB,EAArB,EAAyBH,WAAW,CAACC,QAAZ,CAAqBG,eAArB,CAAqCC,OAA9D,CAAP;AACD,CAhBD;;AAkBA,eAAeX,MAAf"}