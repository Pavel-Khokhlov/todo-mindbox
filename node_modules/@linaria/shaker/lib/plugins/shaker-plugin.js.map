{"version":3,"file":"shaker-plugin.js","names":["hasShakerMetadata","metadata","undefined","getBindingForExport","exportPath","isIdentifier","scope","getBinding","node","name","variableDeclarator","findParent","p","isVariableDeclarator","id","get","isAssignmentExpression","left","withoutRemoved","items","filter","local","isRemoved","rearrangeExports","types","t","root","exportRefs","exports","rearranged","rootScope","forEach","refs","length","uid","generateUid","declaration","unshiftContainer","variableDeclaration","identifier","registerDeclaration","ref","replaced","replaceWith","isBindingIdentifier","registerConstantViolation","reference","pushed","pushContainer","expressionStatement","assignmentExpression","memberExpression","map","exp","exported","shakerPlugin","babel","keepSideEffects","ifUnknownExport","onlyExports","pre","file","filename","opts","log","createCustomDebug","getFileIdx","join","collected","collectExportsAndImports","path","sideEffectImports","imports","sideEffectImport","reexports","find","i","remove","includes","aliveExports","Set","add","isAllExportsFound","size","Error","forDeleting","has","push","deleted","dereferenced","changed","binding","parent","findParentForDelete","outerReferences","referencePaths","isAncestor","dereference","removeWithRelated","visitor","post","Map","imported","source","set","__linariaShaker"],"sources":["../../src/plugins/shaker-plugin.ts"],"sourcesContent":["import type core from '@babel/core';\nimport type { BabelFile, PluginObj, NodePath } from '@babel/core';\nimport type { Binding } from '@babel/traverse';\nimport type {\n  VariableDeclarator,\n  Program,\n  Identifier,\n  MemberExpression,\n} from '@babel/types';\n\nimport { createCustomDebug } from '@linaria/logger';\nimport type { IExport, IReexport, IState } from '@linaria/utils';\nimport {\n  collectExportsAndImports,\n  getFileIdx,\n  isRemoved,\n  removeWithRelated,\n  sideEffectImport,\n  reference,\n  findParentForDelete,\n  dereference,\n} from '@linaria/utils';\n\ntype Core = typeof core;\n\nexport interface IShakerOptions {\n  keepSideEffects?: boolean;\n  ifUnknownExport?: 'error' | 'ignore' | 'reexport-all' | 'skip-shaking';\n  onlyExports: string[];\n}\n\nexport interface IShakerMetadata {\n  imports: Map<string, string[]>;\n}\n\nexport interface IMetadata {\n  __linariaShaker: IShakerMetadata;\n}\n\nexport const hasShakerMetadata = (\n  metadata: object | undefined\n): metadata is IMetadata =>\n  metadata !== undefined && '__linariaShaker' in metadata;\n\nfunction getBindingForExport(exportPath: NodePath): Binding | undefined {\n  if (exportPath.isIdentifier()) {\n    return exportPath.scope.getBinding(exportPath.node.name);\n  }\n\n  const variableDeclarator = exportPath.findParent((p) =>\n    p.isVariableDeclarator()\n  ) as NodePath<VariableDeclarator> | undefined;\n  if (variableDeclarator) {\n    const id = variableDeclarator.get('id');\n    if (id.isIdentifier()) {\n      return variableDeclarator.scope.getBinding(id.node.name);\n    }\n  }\n\n  if (exportPath.isAssignmentExpression()) {\n    const left = exportPath.get('left');\n    if (left.isIdentifier()) {\n      return exportPath.scope.getBinding(left.node.name);\n    }\n  }\n\n  return undefined;\n}\n\nconst withoutRemoved = <T extends { local: NodePath }>(items: T[]): T[] =>\n  items.filter(({ local }) => !isRemoved(local));\n\nfunction rearrangeExports(\n  { types: t }: Core,\n  root: NodePath<Program>,\n  exportRefs: Map<string, NodePath<MemberExpression>[]>,\n  exports: IExport[]\n): IExport[] {\n  let rearranged = [...exports];\n  const rootScope = root.scope;\n  exportRefs.forEach((refs, name) => {\n    if (refs.length <= 1) {\n      return;\n    }\n\n    const uid = rootScope.generateUid(name);\n    // Define variable in the beginning\n    const [declaration] = root.unshiftContainer('body', [\n      t.variableDeclaration('var', [t.variableDeclarator(t.identifier(uid))]),\n    ]);\n\n    rootScope.registerDeclaration(declaration);\n\n    // Replace every reference with defined variable\n    refs.forEach((ref) => {\n      const [replaced] = ref.replaceWith(t.identifier(uid));\n      if (replaced.isBindingIdentifier()) {\n        rootScope.registerConstantViolation(replaced);\n      } else {\n        reference(replaced);\n      }\n    });\n\n    // Assign defined variable to the export\n    const [pushed] = root.pushContainer('body', [\n      t.expressionStatement(\n        t.assignmentExpression(\n          '=',\n          t.memberExpression(t.identifier('exports'), t.identifier(name)),\n          t.identifier(uid)\n        )\n      ),\n    ]);\n\n    const local = pushed.get('expression.right') as NodePath<Identifier>;\n    reference(local);\n\n    rearranged = rearranged.map((exp) =>\n      exp.exported === name\n        ? {\n            ...exp,\n            local,\n          }\n        : exp\n    );\n  });\n\n  return rearranged;\n}\n\nexport default function shakerPlugin(\n  babel: Core,\n  {\n    keepSideEffects = false,\n    ifUnknownExport = 'skip-shaking',\n    onlyExports,\n  }: IShakerOptions\n): PluginObj<IState> {\n  return {\n    name: '@linaria/shaker',\n    pre(file: BabelFile) {\n      this.filename = file.opts.filename!;\n      const log = createCustomDebug('shaker', getFileIdx(this.filename));\n\n      log('start', `${this.filename}, onlyExports: ${onlyExports.join(',')}`);\n\n      const collected = collectExportsAndImports(file.path, file.opts.filename);\n      const sideEffectImports = collected.imports.filter(sideEffectImport);\n      log(\n        'import-and-exports',\n        [\n          `imports: ${collected.imports.length} (side-effects: ${sideEffectImports.length})`,\n          `exports: ${collected.exports.length}`,\n          `reexports: ${collected.reexports.length}`,\n        ].join(', ')\n      );\n\n      // We cannot just throw out exports if they are referred in the code\n      // Let's dome some replacements\n      const exports = rearrangeExports(\n        babel,\n        file.path,\n        collected.exportRefs,\n        collected.exports\n      );\n\n      collected.exports.forEach(({ local }) => {\n        if (local.isAssignmentExpression()) {\n          const left = local.get('left');\n          if (left.isIdentifier()) {\n            // For some reason babel does not mark id in AssignmentExpression as a reference\n            // So we need to do it manually\n            reference(left, left, true);\n          }\n        }\n      });\n\n      if (\n        onlyExports.length === 1 &&\n        onlyExports[0] === '__linariaPreval' &&\n        !exports.find((i) => i.exported === '__linariaPreval')\n      ) {\n        // Fast-lane: if only __linariaPreval is requested, and it's not exported,\n        // we can just shake out the whole file\n        this.imports = [];\n        this.exports = [];\n        this.reexports = [];\n\n        file.path.get('body').forEach((p) => {\n          p.remove();\n        });\n\n        return;\n      }\n\n      if (!onlyExports.includes('*')) {\n        const aliveExports = new Set<IExport | IReexport>();\n        exports.forEach((exp) => {\n          if (onlyExports.includes(exp.exported)) {\n            aliveExports.add(exp);\n          }\n        });\n\n        collected.reexports.forEach((exp) => {\n          if (onlyExports.includes(exp.exported)) {\n            aliveExports.add(exp);\n          }\n        });\n\n        const isAllExportsFound = aliveExports.size === onlyExports.length;\n        if (!isAllExportsFound && ifUnknownExport !== 'ignore') {\n          if (ifUnknownExport === 'error') {\n            throw new Error(\n              `Unknown export(s) requested: ${onlyExports.join(',')}`\n            );\n          }\n\n          if (ifUnknownExport === 'reexport-all') {\n            // If there are unknown exports, we have keep alive all re-exports.\n            exports.forEach((exp) => {\n              if (exp.exported === '*') {\n                aliveExports.add(exp);\n              }\n            });\n\n            collected.reexports.forEach((exp) => {\n              if (exp.exported === '*') {\n                aliveExports.add(exp);\n              }\n            });\n          }\n\n          if (ifUnknownExport === 'skip-shaking') {\n            this.imports = collected.imports;\n            this.exports = exports;\n            this.reexports = collected.reexports;\n\n            return;\n          }\n        }\n\n        const forDeleting = [...exports, ...collected.reexports]\n          .filter((exp) => !aliveExports.has(exp))\n          .map((exp) => exp.local);\n\n        if (!keepSideEffects && sideEffectImports.length > 0) {\n          // Remove all imports that don't import something explicitly\n          sideEffectImports.forEach((i) => forDeleting.push(i.local));\n        }\n\n        const deleted = new Set<NodePath>();\n\n        const dereferenced: NodePath<Identifier>[] = [];\n        let changed = true;\n        while (changed && deleted.size < forDeleting.length) {\n          changed = false;\n          // eslint-disable-next-line no-restricted-syntax\n          for (const path of forDeleting) {\n            const binding = getBindingForExport(path);\n            const parent = findParentForDelete(path);\n            const outerReferences = (binding?.referencePaths || []).filter(\n              (ref) => ref !== parent && !parent?.isAncestor(ref)\n            );\n            if (outerReferences.length > 0 && path.isIdentifier()) {\n              // Temporary deref it in order to simplify further checks.\n              dereference(path);\n              dereferenced.push(path);\n            }\n\n            if (\n              !deleted.has(path) &&\n              (!binding || outerReferences.length === 0)\n            ) {\n              removeWithRelated([parent ?? path]);\n              deleted.add(path);\n              changed = true;\n            }\n          }\n        }\n\n        dereferenced.forEach((path) => {\n          // If path is still alive, we need to reference it back\n          if (!isRemoved(path)) {\n            reference(path);\n          }\n        });\n      }\n\n      this.imports = withoutRemoved(collected.imports);\n      this.exports = withoutRemoved(exports);\n      this.reexports = withoutRemoved(collected.reexports);\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      const log = createCustomDebug('shaker', getFileIdx(file.opts.filename!));\n\n      const imports = new Map<string, string[]>();\n      this.imports.forEach(({ imported, source }) => {\n        if (!imports.has(source)) {\n          imports.set(source, []);\n        }\n\n        if (imported) {\n          imports.get(source)!.push(imported);\n        }\n      });\n\n      this.reexports.forEach(({ imported, source }) => {\n        if (!imports.has(source)) {\n          imports.set(source, []);\n        }\n\n        imports.get(source)!.push(imported);\n      });\n\n      log('end', `remaining imports: %O`, imports);\n\n      // eslint-disable-next-line no-param-reassign\n      (file.metadata as IMetadata).__linariaShaker = {\n        imports,\n      };\n    },\n  };\n}\n"],"mappings":"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"}