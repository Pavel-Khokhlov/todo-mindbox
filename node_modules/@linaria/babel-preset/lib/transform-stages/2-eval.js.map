{"version":3,"file":"2-eval.js","names":["wrap","fn","e","evalStage","resolveCache","codeCache","evalCache","code","options","log","createCustomDebug","getFileIdx","filename","evaluated","evaluate","linariaPreval","hasLinariaPreval","value","__linariaPreval","undefined","valueCache","Map","Object","entries","forEach","key","lazyValue","set","JSON","stringify","dependencies"],"sources":["../../src/transform-stages/2-eval.ts"],"sourcesContent":["import { createCustomDebug } from '@linaria/logger';\nimport type { ValueCache } from '@linaria/tags';\nimport { getFileIdx } from '@linaria/utils';\n\nimport evaluate from '../evaluators';\nimport type Module from '../module';\nimport type { CodeCache, Options } from '../types';\nimport hasLinariaPreval from '../utils/hasLinariaPreval';\n\nconst wrap = <T>(fn: () => T): T | Error => {\n  try {\n    return fn();\n  } catch (e) {\n    return e as Error;\n  }\n};\n\n/**\n * Evaluates template dependencies.\n */\nexport default function evalStage(\n  resolveCache: Map<string, string>,\n  codeCache: CodeCache,\n  evalCache: Map<string, Module>,\n  code: string[],\n  options: Pick<Options, 'filename' | 'pluginOptions'>\n): [ValueCache, string[]] | null {\n  const log = createCustomDebug('transform', getFileIdx(options.filename));\n\n  log('stage-2', `>> evaluate __linariaPreval`);\n\n  const evaluated = evaluate(resolveCache, codeCache, evalCache, code, options);\n\n  const linariaPreval = hasLinariaPreval(evaluated.value)\n    ? evaluated.value.__linariaPreval\n    : undefined;\n\n  if (!linariaPreval) {\n    return null;\n  }\n\n  const valueCache: ValueCache = new Map();\n  Object.entries(linariaPreval).forEach(([key, lazyValue]) => {\n    const value = wrap(lazyValue);\n    valueCache.set(key, value);\n  });\n\n  log('stage-2', `<< evaluated __linariaPreval`, () =>\n    JSON.stringify(valueCache)\n  );\n\n  return [valueCache, evaluated.dependencies];\n}\n"],"mappings":";;;;;;;AAAA;;AAEA;;AAEA;;AAGA;;;;AAEA,MAAMA,IAAI,GAAOC,EAAJ,IAA+B;EAC1C,IAAI;IACF,OAAOA,EAAE,EAAT;EACD,CAFD,CAEE,OAAOC,CAAP,EAAU;IACV,OAAOA,CAAP;EACD;AACF,CAND;AAQA;AACA;AACA;;;AACe,SAASC,SAAT,CACbC,YADa,EAEbC,SAFa,EAGbC,SAHa,EAIbC,IAJa,EAKbC,OALa,EAMkB;EAC/B,MAAMC,GAAG,GAAG,IAAAC,yBAAA,EAAkB,WAAlB,EAA+B,IAAAC,iBAAA,EAAWH,OAAO,CAACI,QAAnB,CAA/B,CAAZ;EAEAH,GAAG,CAAC,SAAD,EAAa,6BAAb,CAAH;EAEA,MAAMI,SAAS,GAAG,IAAAC,mBAAA,EAASV,YAAT,EAAuBC,SAAvB,EAAkCC,SAAlC,EAA6CC,IAA7C,EAAmDC,OAAnD,CAAlB;EAEA,MAAMO,aAAa,GAAG,IAAAC,yBAAA,EAAiBH,SAAS,CAACI,KAA3B,IAClBJ,SAAS,CAACI,KAAV,CAAgBC,eADE,GAElBC,SAFJ;;EAIA,IAAI,CAACJ,aAAL,EAAoB;IAClB,OAAO,IAAP;EACD;;EAED,MAAMK,UAAsB,GAAG,IAAIC,GAAJ,EAA/B;EACAC,MAAM,CAACC,OAAP,CAAeR,aAAf,EAA8BS,OAA9B,CAAsC,CAAC,CAACC,GAAD,EAAMC,SAAN,CAAD,KAAsB;IAC1D,MAAMT,KAAK,GAAGjB,IAAI,CAAC0B,SAAD,CAAlB;IACAN,UAAU,CAACO,GAAX,CAAeF,GAAf,EAAoBR,KAApB;EACD,CAHD;EAKAR,GAAG,CAAC,SAAD,EAAa,8BAAb,EAA4C,MAC7CmB,IAAI,CAACC,SAAL,CAAeT,UAAf,CADC,CAAH;EAIA,OAAO,CAACA,UAAD,EAAaP,SAAS,CAACiB,YAAvB,CAAP;AACD"}