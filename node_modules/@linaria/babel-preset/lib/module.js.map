{"version":3,"file":"module.js","names":["builtins","assert","buffer","child_process","cluster","console","constants","crypto","dgram","dns","domain","events","fs","http","https","module","net","os","path","punycode","process","querystring","readline","repl","stream","string_decoder","sys","timers","tls","tty","url","util","vm","zlib","VALUES","Symbol","isProxy","obj","NOOP","padStart","num","len","toString","Module","isEvaluated","evaluatedFragments","Set","exports","lazyValues","tagProcessors","constructor","filename","options","resolveCache","codeCache","evalCache","debuggerDepth","parentModule","idx","getFileIdx","id","imports","paths","dependencies","transform","debug","createCustomDebug","Object","defineProperties","value","writable","freeze","NativeModule","_nodeModulePaths","dirname","Map","Proxy","get","target","key","values","forEach","v","k","has","ownKeys","Array","from","keys","set","undefined","defineProperty","descriptor","getOwnPropertyDescriptor","enumerable","configurable","extensions","resolve","resolveCacheKey","_extensions","added","ext","push","_resolveFilename","require","assign","resolved","onlyList","split","isAbsolute","Error","m","namespace","extension","extname","includes","code","perExportCache","only","filter","token","codeSet","every","o","add","readFileSync","test","length","JSON","parse","evaluate","ensure","arg","isArray","context","createContext","clearImmediate","clearInterval","clearTimeout","setImmediate","setInterval","setTimeout","global","__filename","__dirname","source","script","Script","runInContext","e","EvalError","callstack","message","join","invalidate","invalidateEvalCache"],"sources":["../src/module.ts"],"sourcesContent":["/**\n * This is a custom implementation for the module system for evaluating code,\n * used for resolving values for dependencies interpolated in `css` or `styled`.\n *\n * This serves 2 purposes:\n * - Avoid leakage from evaluated code to module cache in current context, e.g. `babel-register`\n * - Allow us to invalidate the module cache without affecting other stuff, necessary for rebuilds\n *\n * We also use it to transpile the code with Babel by default.\n * We also store source maps for it to provide correct error stacktraces.\n *\n */\n\nimport fs from 'fs';\nimport NativeModule from 'module';\nimport path from 'path';\nimport vm from 'vm';\n\nimport type { BabelFileResult } from '@babel/core';\n\nimport type { CustomDebug } from '@linaria/logger';\nimport { createCustomDebug } from '@linaria/logger';\nimport type { BaseProcessor } from '@linaria/tags';\nimport type { StrictOptions } from '@linaria/utils';\nimport { getFileIdx } from '@linaria/utils';\n\nimport * as process from './process';\nimport type { CodeCache } from './types';\n\n// Supported node builtins based on the modules polyfilled by webpack\n// `true` means module is polyfilled, `false` means module is empty\nconst builtins = {\n  assert: true,\n  buffer: true,\n  child_process: false,\n  cluster: false,\n  console: true,\n  constants: true,\n  crypto: true,\n  dgram: false,\n  dns: false,\n  domain: true,\n  events: true,\n  fs: false,\n  http: true,\n  https: true,\n  module: false,\n  net: false,\n  os: true,\n  path: true,\n  punycode: true,\n  process: true,\n  querystring: true,\n  readline: false,\n  repl: false,\n  stream: true,\n  string_decoder: true,\n  sys: true,\n  timers: true,\n  tls: false,\n  tty: true,\n  url: true,\n  util: true,\n  vm: true,\n  zlib: true,\n};\n\nconst VALUES = Symbol('values');\n\nconst isProxy = (\n  obj: unknown\n): obj is { [VALUES]: Record<string | symbol, unknown> } =>\n  typeof obj === 'object' && obj !== null && VALUES in obj;\n\nconst NOOP = () => {};\n\nconst padStart = (num: number, len: number) =>\n  num.toString(10).padStart(len, '0');\n\nclass Module {\n  static invalidate: () => void;\n\n  static invalidateEvalCache: () => void;\n\n  static _resolveFilename: (\n    id: string,\n    options: { id: string; filename: string; paths: string[] }\n  ) => string;\n\n  static _nodeModulePaths: (filename: string) => string[];\n\n  #isEvaluated = false;\n\n  #evaluatedFragments = new Set<string>();\n\n  #exports: Record<string, unknown> | unknown;\n\n  // #exportsProxy: Record<string, unknown>;\n\n  #lazyValues: Map<string | symbol, () => unknown>;\n\n  readonly idx: number;\n\n  id: string;\n\n  filename: string;\n\n  options: StrictOptions;\n\n  imports: Map<string, string[]> | null;\n\n  paths: string[];\n\n  extensions: string[];\n\n  dependencies: string[] | null;\n\n  tagProcessors: BaseProcessor[] = [];\n\n  transform: ((text: string) => BabelFileResult | null) | null;\n\n  debug: CustomDebug;\n\n  constructor(\n    filename: string,\n    options: StrictOptions,\n    private resolveCache: Map<string, string>,\n    private codeCache: CodeCache,\n    private evalCache: Map<string, Module>,\n    private debuggerDepth = 0,\n    private parentModule?: Module\n  ) {\n    this.idx = getFileIdx(filename);\n    this.id = filename;\n    this.filename = filename;\n    this.options = options;\n    this.imports = null;\n    this.paths = [];\n    this.dependencies = null;\n    this.transform = null;\n    this.debug = createCustomDebug('module', this.idx);\n\n    Object.defineProperties(this, {\n      id: {\n        value: filename,\n        writable: false,\n      },\n      filename: {\n        value: filename,\n        writable: false,\n      },\n      paths: {\n        value: Object.freeze(\n          (\n            NativeModule as unknown as {\n              _nodeModulePaths(filename: string): string[];\n            }\n          )._nodeModulePaths(path.dirname(filename))\n        ),\n        writable: false,\n      },\n    });\n\n    this.#lazyValues = new Map();\n\n    const exports: Record<string | symbol, unknown> = {};\n\n    this.#exports = new Proxy(exports, {\n      get: (target, key) => {\n        if (key === VALUES) {\n          const values: Record<string | symbol, unknown> = {};\n          this.#lazyValues.forEach((v, k) => {\n            values[k] = v();\n          });\n\n          return values;\n        }\n        const value = this.#lazyValues.get(key)?.();\n        this.debug('evaluated', 'get %s: %o', key, value);\n        return value;\n      },\n      has: (target, key) => {\n        if (key === VALUES) return true;\n        return this.#lazyValues.has(key);\n      },\n      ownKeys: () => {\n        return Array.from(this.#lazyValues.keys());\n      },\n      set: (target, key, value) => {\n        if (value !== undefined) {\n          if (key !== '__esModule') {\n            this.debug('evaluated', 'set %s: %o', key, value);\n          }\n\n          this.#lazyValues.set(key, () => value);\n        }\n\n        return true;\n      },\n      defineProperty: (target, key, descriptor) => {\n        const { value } = descriptor;\n        if (value !== undefined) {\n          this.#lazyValues.set(key, () => value);\n\n          if (key !== '__esModule') {\n            this.debug(\n              'evaluated',\n              'defineProperty %s with value %o',\n              key,\n              value\n            );\n          }\n\n          this.#lazyValues.set(key, () => value);\n\n          return true;\n        }\n\n        if ('get' in descriptor) {\n          this.#lazyValues.set(key, descriptor.get!);\n          this.debug('evaluated', 'defineProperty %s with getter', key);\n        }\n\n        return true;\n      },\n      getOwnPropertyDescriptor() {\n        return {\n          enumerable: true,\n          configurable: true,\n        };\n      },\n    });\n\n    this.extensions = options.extensions;\n    this.debug('init', filename);\n  }\n\n  public get exports() {\n    return this.#exports;\n  }\n\n  public set exports(value) {\n    if (isProxy(value)) {\n      this.#exports = value[VALUES];\n    } else {\n      this.#exports = value;\n    }\n\n    this.debug(\n      'evaluated',\n      'the whole exports was overridden with %O',\n      this.#exports\n    );\n  }\n\n  resolve = (id: string) => {\n    const resolveCacheKey = `${this.filename} -> ${id}`;\n    if (this.resolveCache.has(resolveCacheKey)) {\n      return this.resolveCache.get(resolveCacheKey)!;\n    }\n\n    const extensions = (\n      NativeModule as unknown as {\n        _extensions: { [key: string]: () => void };\n      }\n    )._extensions;\n    const added: string[] = [];\n\n    try {\n      // Check for supported extensions\n      this.extensions.forEach((ext) => {\n        if (ext in extensions) {\n          return;\n        }\n\n        // When an extension is not supported, add it\n        // And keep track of it to clean it up after resolving\n        // Use noop for the transform function since we handle it\n        extensions[ext] = NOOP;\n        added.push(ext);\n      });\n\n      return Module._resolveFilename(id, this);\n    } finally {\n      // Cleanup the extensions we added to restore previous behaviour\n      added.forEach((ext) => delete extensions[ext]);\n    }\n  };\n\n  require: {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    (id: string): any;\n    resolve: (id: string) => string;\n    ensure: () => void;\n  } = Object.assign(\n    (id: string) => {\n      if (id in builtins) {\n        // The module is in the allowed list of builtin node modules\n        // Ideally we should prevent importing them, but webpack polyfills some\n        // So we check for the list of polyfills to determine which ones to support\n        if (builtins[id as keyof typeof builtins]) {\n          this.debug('require', `builtin '${id}'`);\n          return require(id);\n        }\n\n        return null;\n      }\n\n      // Resolve module id (and filename) relatively to parent module\n      const resolved = this.resolve(id);\n      const [filename, onlyList] = resolved.split('\\0');\n      if (filename === id && !path.isAbsolute(id)) {\n        // The module is a builtin node modules, but not in the allowed list\n        throw new Error(\n          `Unable to import \"${id}\". Importing Node builtins is not supported in the sandbox.`\n        );\n      }\n\n      this.dependencies?.push(id);\n\n      let m: Module;\n\n      this.debug('require', `${id} -> ${filename}`);\n\n      if (this.evalCache.has(filename)) {\n        m = this.evalCache.get(filename)!;\n        this.debug('eval-cache', '✅ %r has been gotten from cache', {\n          namespace: `module:${padStart(m.idx, 5)}`,\n        });\n      } else {\n        this.debug('eval-cache', `❌ %r is going to be initialized`, {\n          namespace: `module:${padStart(getFileIdx(filename), 5)}`,\n        });\n        // Create the module if cached module is not available\n        m = new Module(\n          filename,\n          this.options,\n          this.resolveCache,\n          this.codeCache,\n          this.evalCache,\n          this.debuggerDepth + 1,\n          this\n        );\n        m.transform = this.transform;\n\n        // Store it in cache at this point with, otherwise\n        // we would end up in infinite loop with cyclic dependencies\n        this.evalCache.set(filename, m);\n      }\n\n      const extension = path.extname(filename);\n      if (extension === '.json' || this.extensions.includes(extension)) {\n        let code: string[] | undefined;\n        // Requested file can be already prepared for evaluation on the stage 1\n        if (this.codeCache.has(filename)) {\n          const perExportCache = this.codeCache.get(filename)!;\n          const only = onlyList\n            ?.split(',')\n            .filter((token) => !m.#lazyValues.has(token));\n          const codeSet = new Set<string>();\n          if (only && only.every((o) => perExportCache.has(o))) {\n            m.debug('code-cache', '✅');\n            only.forEach((o) => codeSet.add(perExportCache.get(o)!.code));\n          } else if (!only && perExportCache.has('*')) {\n            m.debug('code-cache', '✳️');\n            // The whole file is required\n            codeSet.add(perExportCache.get('*')!.code);\n          }\n\n          code = Array.from(codeSet);\n        } else if (m.#isEvaluated) {\n          m.debug(\n            'code-cache',\n            '✅ not in the code cache, but is already evaluated'\n          );\n          code = [];\n        }\n\n        if (!code) {\n          // If code wasn't extracted from cache, read it from the file system\n          // TODO: transpile the file\n          m.debug('code-cache', '❌');\n          code = [fs.readFileSync(filename, 'utf-8')];\n        }\n\n        if (/\\.json$/.test(filename) && code.length === 1) {\n          // For JSON files, parse it to a JS object similar to Node\n          m.exports = JSON.parse(code[0]);\n          m.#isEvaluated = true;\n        } else {\n          // For JS/TS files, evaluate the module\n          m.evaluate(code);\n        }\n      } else {\n        // For non JS/JSON requires, just export the id\n        // This is to support importing assets in webpack\n        // The module will be resolved by css-loader\n        m.exports = filename;\n        m.#isEvaluated = true;\n      }\n\n      return m.exports;\n    },\n    {\n      ensure: NOOP,\n      resolve: this.resolve,\n    }\n  );\n\n  evaluate(arg: string | string[]): void {\n    const code = Array.isArray(arg) ? arg : [arg];\n    const { filename } = this;\n\n    if (code.length === 0) {\n      this.debug(`evaluate`, 'there is nothing to evaluate');\n    }\n\n    const context = vm.createContext({\n      clearImmediate: NOOP,\n      clearInterval: NOOP,\n      clearTimeout: NOOP,\n      setImmediate: NOOP,\n      setInterval: NOOP,\n      setTimeout: NOOP,\n      global,\n      process,\n      module: this,\n      exports: this.#exports,\n      require: this.require,\n      __filename: filename,\n      __dirname: path.dirname(filename),\n    });\n\n    code.forEach((source, idx) => {\n      if (this.#evaluatedFragments.has(source)) {\n        this.debug(\n          `evaluate:fragment-${padStart(idx + 1, 2)}`,\n          `is already evaluated`\n        );\n        return;\n      }\n\n      this.debug(`evaluate:fragment-${padStart(idx + 1, 2)}`, `\\n${source}`);\n\n      this.#evaluatedFragments.add(source);\n\n      this.#isEvaluated = true;\n\n      try {\n        const script = new vm.Script(\n          `(function (exports) { ${source}\\n})(exports);`,\n          {\n            filename,\n          }\n        );\n\n        script.runInContext(context);\n        return;\n      } catch (e) {\n        if (e instanceof EvalError) {\n          throw e;\n        }\n\n        const callstack: string[] = ['', this.filename];\n        let module = this.parentModule;\n        while (module) {\n          callstack.push(module.filename);\n          module = module.parentModule;\n        }\n\n        this.debug('evaluate:error', '%O\\n%O', e, callstack);\n        throw new EvalError(\n          `${(e as Error).message} in${callstack.join('\\n| ')}\\n`\n        );\n      }\n    });\n  }\n}\n\nModule.invalidate = () => {};\n\nModule.invalidateEvalCache = () => {};\n\n// Alias to resolve the module using node's resolve algorithm\n// This static property can be overriden by the webpack loader\n// This allows us to use webpack's module resolution algorithm\nModule._resolveFilename = (id, options) =>\n  (\n    NativeModule as unknown as {\n      _resolveFilename: typeof Module._resolveFilename;\n    }\n  )._resolveFilename(id, options);\n\nModule._nodeModulePaths = (filename: string) =>\n  (\n    NativeModule as unknown as {\n      _nodeModulePaths: (filename: string) => string[];\n    }\n  )._nodeModulePaths(filename);\n\nexport default Module;\n"],"mappings":";;;;;;;AAaA;;AACA;;AACA;;AACA;;AAKA;;AAGA;;AAEA;;;;;;;;AA1BA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AAkBA;AACA;AACA,MAAMA,QAAQ,GAAG;EACfC,MAAM,EAAE,IADO;EAEfC,MAAM,EAAE,IAFO;EAGfC,aAAa,EAAE,KAHA;EAIfC,OAAO,EAAE,KAJM;EAKfC,OAAO,EAAE,IALM;EAMfC,SAAS,EAAE,IANI;EAOfC,MAAM,EAAE,IAPO;EAQfC,KAAK,EAAE,KARQ;EASfC,GAAG,EAAE,KATU;EAUfC,MAAM,EAAE,IAVO;EAWfC,MAAM,EAAE,IAXO;EAYfC,EAAE,EAAE,KAZW;EAafC,IAAI,EAAE,IAbS;EAcfC,KAAK,EAAE,IAdQ;EAefC,MAAM,EAAE,KAfO;EAgBfC,GAAG,EAAE,KAhBU;EAiBfC,EAAE,EAAE,IAjBW;EAkBfC,IAAI,EAAE,IAlBS;EAmBfC,QAAQ,EAAE,IAnBK;EAoBfC,OAAO,EAAE,IApBM;EAqBfC,WAAW,EAAE,IArBE;EAsBfC,QAAQ,EAAE,KAtBK;EAuBfC,IAAI,EAAE,KAvBS;EAwBfC,MAAM,EAAE,IAxBO;EAyBfC,cAAc,EAAE,IAzBD;EA0BfC,GAAG,EAAE,IA1BU;EA2BfC,MAAM,EAAE,IA3BO;EA4BfC,GAAG,EAAE,KA5BU;EA6BfC,GAAG,EAAE,IA7BU;EA8BfC,GAAG,EAAE,IA9BU;EA+BfC,IAAI,EAAE,IA/BS;EAgCfC,EAAE,EAAE,IAhCW;EAiCfC,IAAI,EAAE;AAjCS,CAAjB;AAoCA,MAAMC,MAAM,GAAGC,MAAM,CAAC,QAAD,CAArB;;AAEA,MAAMC,OAAO,GACXC,GADc,IAGd,OAAOA,GAAP,KAAe,QAAf,IAA2BA,GAAG,KAAK,IAAnC,IAA2CH,MAAM,IAAIG,GAHvD;;AAKA,MAAMC,IAAI,GAAG,MAAM,CAAE,CAArB;;AAEA,MAAMC,QAAQ,GAAG,CAACC,GAAD,EAAcC,GAAd,KACfD,GAAG,CAACE,QAAJ,CAAa,EAAb,EAAiBH,QAAjB,CAA0BE,GAA1B,EAA+B,GAA/B,CADF;;AAGA,MAAME,MAAN,CAAa;EAYX,CAACC,WAAD,GAAe,KAAf;EAEA,CAACC,kBAAD,GAAsB,IAAIC,GAAJ,EAAtB;EAEA,CAACC,OAAD,CAhBW,CAkBX;;EAEA,CAACC,UAAD;EAkBAC,aAAa,GAAoB,EAApB;;EAMbC,WAAW,CACTC,QADS,EAETC,OAFS,EAGDC,YAHC,EAIDC,SAJC,EAKDC,SALC,EAMDC,aAAa,GAAG,CANf,EAODC,YAPC,EAQT;IAAA,KALQJ,YAKR,GALQA,YAKR;IAAA,KAJQC,SAIR,GAJQA,SAIR;IAAA,KAHQC,SAGR,GAHQA,SAGR;IAAA,KAFQC,aAER,GAFQA,aAER;IAAA,KADQC,YACR,GADQA,YACR;IACA,KAAKC,GAAL,GAAW,IAAAC,iBAAA,EAAWR,QAAX,CAAX;IACA,KAAKS,EAAL,GAAUT,QAAV;IACA,KAAKA,QAAL,GAAgBA,QAAhB;IACA,KAAKC,OAAL,GAAeA,OAAf;IACA,KAAKS,OAAL,GAAe,IAAf;IACA,KAAKC,KAAL,GAAa,EAAb;IACA,KAAKC,YAAL,GAAoB,IAApB;IACA,KAAKC,SAAL,GAAiB,IAAjB;IACA,KAAKC,KAAL,GAAa,IAAAC,yBAAA,EAAkB,QAAlB,EAA4B,KAAKR,GAAjC,CAAb;IAEAS,MAAM,CAACC,gBAAP,CAAwB,IAAxB,EAA8B;MAC5BR,EAAE,EAAE;QACFS,KAAK,EAAElB,QADL;QAEFmB,QAAQ,EAAE;MAFR,CADwB;MAK5BnB,QAAQ,EAAE;QACRkB,KAAK,EAAElB,QADC;QAERmB,QAAQ,EAAE;MAFF,CALkB;MAS5BR,KAAK,EAAE;QACLO,KAAK,EAAEF,MAAM,CAACI,MAAP,CAEHC,eADF,CAIEC,gBAJF,CAImBvD,aAAA,CAAKwD,OAAL,CAAavB,QAAb,CAJnB,CADK,CADF;QAQLmB,QAAQ,EAAE;MARL;IATqB,CAA9B;IAqBA,KAAK,CAACtB,UAAN,GAAmB,IAAI2B,GAAJ,EAAnB;IAEA,MAAM5B,OAAyC,GAAG,EAAlD;IAEA,KAAK,CAACA,OAAN,GAAgB,IAAI6B,KAAJ,CAAU7B,OAAV,EAAmB;MACjC8B,GAAG,EAAE,CAACC,MAAD,EAASC,GAAT,KAAiB;QAAA;;QACpB,IAAIA,GAAG,KAAK7C,MAAZ,EAAoB;UAClB,MAAM8C,MAAwC,GAAG,EAAjD;UACA,KAAK,CAAChC,UAAN,CAAiBiC,OAAjB,CAAyB,CAACC,CAAD,EAAIC,CAAJ,KAAU;YACjCH,MAAM,CAACG,CAAD,CAAN,GAAYD,CAAC,EAAb;UACD,CAFD;UAIA,OAAOF,MAAP;QACD;;QACD,MAAMX,KAAK,2BAAG,KAAK,CAACrB,UAAN,CAAiB6B,GAAjB,CAAqBE,GAArB,CAAH,yDAAG,sBAAd;QACA,KAAKd,KAAL,CAAW,WAAX,EAAwB,YAAxB,EAAsCc,GAAtC,EAA2CV,KAA3C;QACA,OAAOA,KAAP;MACD,CAbgC;MAcjCe,GAAG,EAAE,CAACN,MAAD,EAASC,GAAT,KAAiB;QACpB,IAAIA,GAAG,KAAK7C,MAAZ,EAAoB,OAAO,IAAP;QACpB,OAAO,KAAK,CAACc,UAAN,CAAiBoC,GAAjB,CAAqBL,GAArB,CAAP;MACD,CAjBgC;MAkBjCM,OAAO,EAAE,MAAM;QACb,OAAOC,KAAK,CAACC,IAAN,CAAW,KAAK,CAACvC,UAAN,CAAiBwC,IAAjB,EAAX,CAAP;MACD,CApBgC;MAqBjCC,GAAG,EAAE,CAACX,MAAD,EAASC,GAAT,EAAcV,KAAd,KAAwB;QAC3B,IAAIA,KAAK,KAAKqB,SAAd,EAAyB;UACvB,IAAIX,GAAG,KAAK,YAAZ,EAA0B;YACxB,KAAKd,KAAL,CAAW,WAAX,EAAwB,YAAxB,EAAsCc,GAAtC,EAA2CV,KAA3C;UACD;;UAED,KAAK,CAACrB,UAAN,CAAiByC,GAAjB,CAAqBV,GAArB,EAA0B,MAAMV,KAAhC;QACD;;QAED,OAAO,IAAP;MACD,CA/BgC;MAgCjCsB,cAAc,EAAE,CAACb,MAAD,EAASC,GAAT,EAAca,UAAd,KAA6B;QAC3C,MAAM;UAAEvB;QAAF,IAAYuB,UAAlB;;QACA,IAAIvB,KAAK,KAAKqB,SAAd,EAAyB;UACvB,KAAK,CAAC1C,UAAN,CAAiByC,GAAjB,CAAqBV,GAArB,EAA0B,MAAMV,KAAhC;;UAEA,IAAIU,GAAG,KAAK,YAAZ,EAA0B;YACxB,KAAKd,KAAL,CACE,WADF,EAEE,iCAFF,EAGEc,GAHF,EAIEV,KAJF;UAMD;;UAED,KAAK,CAACrB,UAAN,CAAiByC,GAAjB,CAAqBV,GAArB,EAA0B,MAAMV,KAAhC;UAEA,OAAO,IAAP;QACD;;QAED,IAAI,SAASuB,UAAb,EAAyB;UACvB,KAAK,CAAC5C,UAAN,CAAiByC,GAAjB,CAAqBV,GAArB,EAA0Ba,UAAU,CAACf,GAArC;UACA,KAAKZ,KAAL,CAAW,WAAX,EAAwB,+BAAxB,EAAyDc,GAAzD;QACD;;QAED,OAAO,IAAP;MACD,CAzDgC;;MA0DjCc,wBAAwB,GAAG;QACzB,OAAO;UACLC,UAAU,EAAE,IADP;UAELC,YAAY,EAAE;QAFT,CAAP;MAID;;IA/DgC,CAAnB,CAAhB;IAkEA,KAAKC,UAAL,GAAkB5C,OAAO,CAAC4C,UAA1B;IACA,KAAK/B,KAAL,CAAW,MAAX,EAAmBd,QAAnB;EACD;;EAEiB,IAAPJ,OAAO,GAAG;IACnB,OAAO,KAAK,CAACA,OAAb;EACD;;EAEiB,IAAPA,OAAO,CAACsB,KAAD,EAAQ;IACxB,IAAIjC,OAAO,CAACiC,KAAD,CAAX,EAAoB;MAClB,KAAK,CAACtB,OAAN,GAAgBsB,KAAK,CAACnC,MAAD,CAArB;IACD,CAFD,MAEO;MACL,KAAK,CAACa,OAAN,GAAgBsB,KAAhB;IACD;;IAED,KAAKJ,KAAL,CACE,WADF,EAEE,0CAFF,EAGE,KAAK,CAAClB,OAHR;EAKD;;EAEDkD,OAAO,GAAIrC,EAAD,IAAgB;IACxB,MAAMsC,eAAe,GAAI,GAAE,KAAK/C,QAAS,OAAMS,EAAG,EAAlD;;IACA,IAAI,KAAKP,YAAL,CAAkB+B,GAAlB,CAAsBc,eAAtB,CAAJ,EAA4C;MAC1C,OAAO,KAAK7C,YAAL,CAAkBwB,GAAlB,CAAsBqB,eAAtB,CAAP;IACD;;IAED,MAAMF,UAAU,GACdxB,eADiB,CAIjB2B,WAJF;IAKA,MAAMC,KAAe,GAAG,EAAxB;;IAEA,IAAI;MACF;MACA,KAAKJ,UAAL,CAAgBf,OAAhB,CAAyBoB,GAAD,IAAS;QAC/B,IAAIA,GAAG,IAAIL,UAAX,EAAuB;UACrB;QACD,CAH8B,CAK/B;QACA;QACA;;;QACAA,UAAU,CAACK,GAAD,CAAV,GAAkB/D,IAAlB;QACA8D,KAAK,CAACE,IAAN,CAAWD,GAAX;MACD,CAVD;MAYA,OAAO1D,MAAM,CAAC4D,gBAAP,CAAwB3C,EAAxB,EAA4B,IAA5B,CAAP;IACD,CAfD,SAeU;MACR;MACAwC,KAAK,CAACnB,OAAN,CAAeoB,GAAD,IAAS,OAAOL,UAAU,CAACK,GAAD,CAAxC;IACD;EACF,CAhCM;EAkCPG,OAAO,GAKHrC,MAAM,CAACsC,MAAP,CACD7C,EAAD,IAAgB;IAAA;;IACd,IAAIA,EAAE,IAAI5D,QAAV,EAAoB;MAClB;MACA;MACA;MACA,IAAIA,QAAQ,CAAC4D,EAAD,CAAZ,EAA2C;QACzC,KAAKK,KAAL,CAAW,SAAX,EAAuB,YAAWL,EAAG,GAArC;QACA,OAAO4C,OAAO,CAAC5C,EAAD,CAAd;MACD;;MAED,OAAO,IAAP;IACD,CAXa,CAad;;;IACA,MAAM8C,QAAQ,GAAG,KAAKT,OAAL,CAAarC,EAAb,CAAjB;IACA,MAAM,CAACT,QAAD,EAAWwD,QAAX,IAAuBD,QAAQ,CAACE,KAAT,CAAe,IAAf,CAA7B;;IACA,IAAIzD,QAAQ,KAAKS,EAAb,IAAmB,CAAC1C,aAAA,CAAK2F,UAAL,CAAgBjD,EAAhB,CAAxB,EAA6C;MAC3C;MACA,MAAM,IAAIkD,KAAJ,CACH,qBAAoBlD,EAAG,6DADpB,CAAN;IAGD;;IAED,2BAAKG,YAAL,0EAAmBuC,IAAnB,CAAwB1C,EAAxB;IAEA,IAAImD,CAAJ;IAEA,KAAK9C,KAAL,CAAW,SAAX,EAAuB,GAAEL,EAAG,OAAMT,QAAS,EAA3C;;IAEA,IAAI,KAAKI,SAAL,CAAe6B,GAAf,CAAmBjC,QAAnB,CAAJ,EAAkC;MAChC4D,CAAC,GAAG,KAAKxD,SAAL,CAAesB,GAAf,CAAmB1B,QAAnB,CAAJ;MACA,KAAKc,KAAL,CAAW,YAAX,EAAyB,iCAAzB,EAA4D;QAC1D+C,SAAS,EAAG,UAASzE,QAAQ,CAACwE,CAAC,CAACrD,GAAH,EAAQ,CAAR,CAAW;MADkB,CAA5D;IAGD,CALD,MAKO;MACL,KAAKO,KAAL,CAAW,YAAX,EAA0B,iCAA1B,EAA4D;QAC1D+C,SAAS,EAAG,UAASzE,QAAQ,CAAC,IAAAoB,iBAAA,EAAWR,QAAX,CAAD,EAAuB,CAAvB,CAA0B;MADG,CAA5D,EADK,CAIL;;MACA4D,CAAC,GAAG,IAAIpE,MAAJ,CACFQ,QADE,EAEF,KAAKC,OAFH,EAGF,KAAKC,YAHH,EAIF,KAAKC,SAJH,EAKF,KAAKC,SALH,EAMF,KAAKC,aAAL,GAAqB,CANnB,EAOF,IAPE,CAAJ;MASAuD,CAAC,CAAC/C,SAAF,GAAc,KAAKA,SAAnB,CAdK,CAgBL;MACA;;MACA,KAAKT,SAAL,CAAekC,GAAf,CAAmBtC,QAAnB,EAA6B4D,CAA7B;IACD;;IAED,MAAME,SAAS,GAAG/F,aAAA,CAAKgG,OAAL,CAAa/D,QAAb,CAAlB;;IACA,IAAI8D,SAAS,KAAK,OAAd,IAAyB,KAAKjB,UAAL,CAAgBmB,QAAhB,CAAyBF,SAAzB,CAA7B,EAAkE;MAChE,IAAIG,IAAJ,CADgE,CAEhE;;MACA,IAAI,KAAK9D,SAAL,CAAe8B,GAAf,CAAmBjC,QAAnB,CAAJ,EAAkC;QAChC,MAAMkE,cAAc,GAAG,KAAK/D,SAAL,CAAeuB,GAAf,CAAmB1B,QAAnB,CAAvB;QACA,MAAMmE,IAAI,GAAGX,QAAH,aAAGA,QAAH,uBAAGA,QAAQ,CACjBC,KADS,CACH,GADG,EAEVW,MAFU,CAEFC,KAAD,IAAW,CAACT,CAAC,CAAC,CAAC/D,UAAH,CAAcoC,GAAd,CAAkBoC,KAAlB,CAFT,CAAb;QAGA,MAAMC,OAAO,GAAG,IAAI3E,GAAJ,EAAhB;;QACA,IAAIwE,IAAI,IAAIA,IAAI,CAACI,KAAL,CAAYC,CAAD,IAAON,cAAc,CAACjC,GAAf,CAAmBuC,CAAnB,CAAlB,CAAZ,EAAsD;UACpDZ,CAAC,CAAC9C,KAAF,CAAQ,YAAR,EAAsB,GAAtB;UACAqD,IAAI,CAACrC,OAAL,CAAc0C,CAAD,IAAOF,OAAO,CAACG,GAAR,CAAYP,cAAc,CAACxC,GAAf,CAAmB8C,CAAnB,EAAuBP,IAAnC,CAApB;QACD,CAHD,MAGO,IAAI,CAACE,IAAD,IAASD,cAAc,CAACjC,GAAf,CAAmB,GAAnB,CAAb,EAAsC;UAC3C2B,CAAC,CAAC9C,KAAF,CAAQ,YAAR,EAAsB,IAAtB,EAD2C,CAE3C;;UACAwD,OAAO,CAACG,GAAR,CAAYP,cAAc,CAACxC,GAAf,CAAmB,GAAnB,EAAyBuC,IAArC;QACD;;QAEDA,IAAI,GAAG9B,KAAK,CAACC,IAAN,CAAWkC,OAAX,CAAP;MACD,CAhBD,MAgBO,IAAIV,CAAC,CAAC,CAACnE,WAAP,EAAoB;QACzBmE,CAAC,CAAC9C,KAAF,CACE,YADF,EAEE,mDAFF;QAIAmD,IAAI,GAAG,EAAP;MACD;;MAED,IAAI,CAACA,IAAL,EAAW;QACT;QACA;QACAL,CAAC,CAAC9C,KAAF,CAAQ,YAAR,EAAsB,GAAtB;QACAmD,IAAI,GAAG,CAACxG,WAAA,CAAGiH,YAAH,CAAgB1E,QAAhB,EAA0B,OAA1B,CAAD,CAAP;MACD;;MAED,IAAI,UAAU2E,IAAV,CAAe3E,QAAf,KAA4BiE,IAAI,CAACW,MAAL,KAAgB,CAAhD,EAAmD;QACjD;QACAhB,CAAC,CAAChE,OAAF,GAAYiF,IAAI,CAACC,KAAL,CAAWb,IAAI,CAAC,CAAD,CAAf,CAAZ;QACAL,CAAC,CAAC,CAACnE,WAAH,GAAiB,IAAjB;MACD,CAJD,MAIO;QACL;QACAmE,CAAC,CAACmB,QAAF,CAAWd,IAAX;MACD;IACF,CA1CD,MA0CO;MACL;MACA;MACA;MACAL,CAAC,CAAChE,OAAF,GAAYI,QAAZ;MACA4D,CAAC,CAAC,CAACnE,WAAH,GAAiB,IAAjB;IACD;;IAED,OAAOmE,CAAC,CAAChE,OAAT;EACD,CA5GC,EA6GF;IACEoF,MAAM,EAAE7F,IADV;IAEE2D,OAAO,EAAE,KAAKA;EAFhB,CA7GE,CALG;;EAwHPiC,QAAQ,CAACE,GAAD,EAA+B;IACrC,MAAMhB,IAAI,GAAG9B,KAAK,CAAC+C,OAAN,CAAcD,GAAd,IAAqBA,GAArB,GAA2B,CAACA,GAAD,CAAxC;IACA,MAAM;MAAEjF;IAAF,IAAe,IAArB;;IAEA,IAAIiE,IAAI,CAACW,MAAL,KAAgB,CAApB,EAAuB;MACrB,KAAK9D,KAAL,CAAY,UAAZ,EAAuB,8BAAvB;IACD;;IAED,MAAMqE,OAAO,GAAGtG,WAAA,CAAGuG,aAAH,CAAiB;MAC/BC,cAAc,EAAElG,IADe;MAE/BmG,aAAa,EAAEnG,IAFgB;MAG/BoG,YAAY,EAAEpG,IAHiB;MAI/BqG,YAAY,EAAErG,IAJiB;MAK/BsG,WAAW,EAAEtG,IALkB;MAM/BuG,UAAU,EAAEvG,IANmB;MAO/BwG,MAP+B;MAQ/B1H,OAR+B;MAS/BL,MAAM,EAAE,IATuB;MAU/BgC,OAAO,EAAE,KAAK,CAACA,OAVgB;MAW/ByD,OAAO,EAAE,KAAKA,OAXiB;MAY/BuC,UAAU,EAAE5F,QAZmB;MAa/B6F,SAAS,EAAE9H,aAAA,CAAKwD,OAAL,CAAavB,QAAb;IAboB,CAAjB,CAAhB;;IAgBAiE,IAAI,CAACnC,OAAL,CAAa,CAACgE,MAAD,EAASvF,GAAT,KAAiB;MAC5B,IAAI,KAAK,CAACb,kBAAN,CAAyBuC,GAAzB,CAA6B6D,MAA7B,CAAJ,EAA0C;QACxC,KAAKhF,KAAL,CACG,qBAAoB1B,QAAQ,CAACmB,GAAG,GAAG,CAAP,EAAU,CAAV,CAAa,EAD5C,EAEG,sBAFH;QAIA;MACD;;MAED,KAAKO,KAAL,CAAY,qBAAoB1B,QAAQ,CAACmB,GAAG,GAAG,CAAP,EAAU,CAAV,CAAa,EAArD,EAAyD,KAAIuF,MAAO,EAApE;MAEA,KAAK,CAACpG,kBAAN,CAAyB+E,GAAzB,CAA6BqB,MAA7B;MAEA,KAAK,CAACrG,WAAN,GAAoB,IAApB;;MAEA,IAAI;QACF,MAAMsG,MAAM,GAAG,IAAIlH,WAAA,CAAGmH,MAAP,CACZ,yBAAwBF,MAAO,gBADnB,EAEb;UACE9F;QADF,CAFa,CAAf;QAOA+F,MAAM,CAACE,YAAP,CAAoBd,OAApB;QACA;MACD,CAVD,CAUE,OAAOe,CAAP,EAAU;QACV,IAAIA,CAAC,YAAYC,SAAjB,EAA4B;UAC1B,MAAMD,CAAN;QACD;;QAED,MAAME,SAAmB,GAAG,CAAC,EAAD,EAAK,KAAKpG,QAAV,CAA5B;QACA,IAAIpC,MAAM,GAAG,KAAK0C,YAAlB;;QACA,OAAO1C,MAAP,EAAe;UACbwI,SAAS,CAACjD,IAAV,CAAevF,MAAM,CAACoC,QAAtB;UACApC,MAAM,GAAGA,MAAM,CAAC0C,YAAhB;QACD;;QAED,KAAKQ,KAAL,CAAW,gBAAX,EAA6B,QAA7B,EAAuCoF,CAAvC,EAA0CE,SAA1C;QACA,MAAM,IAAID,SAAJ,CACH,GAAGD,CAAD,CAAaG,OAAQ,MAAKD,SAAS,CAACE,IAAV,CAAe,MAAf,CAAuB,IADhD,CAAN;MAGD;IACF,CA1CD;EA2CD;;AA7YU;;AAgZb9G,MAAM,CAAC+G,UAAP,GAAoB,MAAM,CAAE,CAA5B;;AAEA/G,MAAM,CAACgH,mBAAP,GAA6B,MAAM,CAAE,CAArC,C,CAEA;AACA;AACA;;;AACAhH,MAAM,CAAC4D,gBAAP,GAA0B,CAAC3C,EAAD,EAAKR,OAAL,KAEtBoB,eADF,CAIE+B,gBAJF,CAImB3C,EAJnB,EAIuBR,OAJvB,CADF;;AAOAT,MAAM,CAAC8B,gBAAP,GAA2BtB,QAAD,IAEtBqB,eADF,CAIEC,gBAJF,CAImBtB,QAJnB,CADF;;eAOeR,M"}