{"version":3,"file":"preeval.js","names":["createCustomDebug","collectExportsAndImports","getFileIdx","JSXElementsRemover","removeWithRelated","processTemplateExpression","isGlobal","id","scope","name","node","hasBinding","hasGlobal","forbiddenGlobals","Set","isBrowserGlobal","has","isHookOrCreateElement","test","isUnnecessaryReact","p","imports","reactImports","filter","i","source","imported","length","callee","get","isIdentifier","bindingPath","getBinding","path","some","isAncestor","local","isMemberExpression","object","property","defaultImport","find","preeval","babel","options","types","t","pre","file","log","opts","filename","jsxRuntime","jsxRuntimeName","processors","traverse","Identifier","processor","doEvaltimeReplacement","push","CallExpression","enter","JSXElement","JSXFragment","parentPath","isUnaryExpression","operator","visitor","post","metadata","linaria","replacements","rules","dependencies","expressions","flatMap","map","dependency","ex","linariaPreval","getData","linariaExport","expressionStatement","assignmentExpression","memberExpression","identifier","objectExpression","objectProperty","pushContainer"],"sources":["../../src/plugins/preeval.ts"],"sourcesContent":["/**\n * This file is a babel preset used to transform files inside evaluators.\n * It works the same as main `babel/extract` preset, but do not evaluate lazy dependencies.\n */\nimport type { BabelFile, NodePath, PluginObj } from '@babel/core';\nimport type { CallExpression, Identifier } from '@babel/types';\n\nimport { createCustomDebug } from '@linaria/logger';\nimport type { StrictOptions, IImport, ISideEffectImport } from '@linaria/utils';\nimport {\n  collectExportsAndImports,\n  getFileIdx,\n  JSXElementsRemover,\n  removeWithRelated,\n} from '@linaria/utils';\n\nimport type { Core } from '../babel';\nimport type { IPluginState } from '../types';\nimport processTemplateExpression from '../utils/processTemplateExpression';\n\nexport type PreevalOptions = Pick<\n  StrictOptions,\n  'classNameSlug' | 'displayName' | 'evaluate'\n>;\n\nconst isGlobal = (id: NodePath<Identifier>): boolean => {\n  const { scope } = id;\n  const { name } = id.node;\n  return !scope.hasBinding(name) && scope.hasGlobal(name);\n};\n\nconst forbiddenGlobals = new Set([\n  'XMLHttpRequest',\n  'clearImmediate',\n  'clearInterval',\n  'clearTimeout',\n  'document',\n  'fetch',\n  'localStorage',\n  'location',\n  'navigator',\n  'sessionStorage',\n  'setImmediate',\n  'setInterval',\n  'setTimeout',\n  'window',\n]);\n\nconst isBrowserGlobal = (id: NodePath<Identifier>) => {\n  return forbiddenGlobals.has(id.node.name) && isGlobal(id);\n};\n\nfunction isHookOrCreateElement(name: string): boolean {\n  return name === 'createElement' || /use[A-Z]/.test(name);\n}\n\nfunction isUnnecessaryReact(\n  p: NodePath<CallExpression>,\n  imports: (IImport | ISideEffectImport)[]\n): boolean {\n  const reactImports = imports.filter(\n    (i) =>\n      i.source === 'react' &&\n      (i.imported === 'default' ||\n        (i.imported && isHookOrCreateElement(i.imported)))\n  ) as IImport[];\n\n  if (reactImports.length === 0) return false;\n  const callee = p.get('callee');\n  if (callee.isIdentifier() && isHookOrCreateElement(callee.node.name)) {\n    const bindingPath = callee.scope.getBinding(callee.node.name)?.path;\n    return reactImports.some((i) => bindingPath?.isAncestor(i.local));\n  }\n\n  if (callee.isMemberExpression()) {\n    if (reactImports.some((i) => i.local === callee)) {\n      // It's React.createElement in CJS\n      return true;\n    }\n\n    const object = callee.get('object');\n    const property = callee.get('property');\n    const defaultImport = reactImports.find((i) => i.imported === 'default');\n    if (\n      !defaultImport ||\n      !defaultImport.local.isIdentifier() ||\n      !property.isIdentifier() ||\n      !isHookOrCreateElement(property.node.name) ||\n      !object.isIdentifier({ name: defaultImport.local.node.name })\n    ) {\n      return false;\n    }\n\n    const bindingPath = object.scope.getBinding(object.node.name)?.path;\n    return bindingPath?.isAncestor(defaultImport.local) ?? false;\n  }\n\n  return false;\n}\n\nexport default function preeval(\n  babel: Core,\n  options: PreevalOptions\n): PluginObj<IPluginState> {\n  const { types: t } = babel;\n  return {\n    name: '@linaria/babel/preeval',\n    pre(file: BabelFile) {\n      const log = createCustomDebug('preeval', getFileIdx(file.opts.filename!));\n\n      log('start', 'Looking for template literalsâ€¦');\n\n      const { imports } = collectExportsAndImports(\n        file.path,\n        file.opts.filename\n      );\n\n      const jsxRuntime = imports.find((i) => i.source === 'react/jsx-runtime');\n      const jsxRuntimeName =\n        jsxRuntime?.local?.isIdentifier() && jsxRuntime?.local?.node?.name;\n\n      this.processors = [];\n\n      file.path.traverse({\n        Identifier: (p) => {\n          processTemplateExpression(p, file.opts, options, (processor) => {\n            processor.doEvaltimeReplacement();\n            this.processors.push(processor);\n          });\n        },\n      });\n\n      log('start', 'Strip all JSX and browser related stuff');\n      file.path.traverse({\n        // JSX can be replaced with a dummy value,\n        // but we have to do it after we processed template tags.\n        CallExpression: {\n          enter(p) {\n            if (jsxRuntimeName) {\n              const callee = p.get('callee');\n              if (callee.isIdentifier({ name: jsxRuntimeName })) {\n                JSXElementsRemover(p);\n              }\n            }\n\n            if (isUnnecessaryReact(p, imports)) {\n              JSXElementsRemover(p);\n            }\n          },\n        },\n        JSXElement: {\n          enter: JSXElementsRemover,\n        },\n        JSXFragment: {\n          enter: JSXElementsRemover,\n        },\n        Identifier(p) {\n          if (isBrowserGlobal(p)) {\n            if (p.parentPath.isUnaryExpression({ operator: 'typeof' })) {\n              // Ignore `typeof window` expressions\n              return;\n            }\n\n            removeWithRelated([p]);\n          }\n        },\n      });\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      const log = createCustomDebug('preeval', getFileIdx(file.opts.filename!));\n\n      if (this.processors.length === 0) {\n        log('end', \"We didn't find any Linaria template literals\");\n\n        // We didn't find any Linaria template literals.\n        return;\n      }\n\n      this.file.metadata.linaria = {\n        processors: this.processors,\n        replacements: [],\n        rules: {},\n        dependencies: [],\n      };\n\n      const expressions: Identifier[] = this.processors.flatMap((processor) =>\n        processor.dependencies.map((dependency) => dependency.ex)\n      );\n\n      const linariaPreval = file.path.scope.getData('__linariaPreval');\n      if (!linariaPreval) {\n        const linariaExport = t.expressionStatement(\n          t.assignmentExpression(\n            '=',\n            t.memberExpression(\n              t.identifier('exports'),\n              t.identifier('__linariaPreval')\n            ),\n            t.objectExpression(\n              expressions.map((ex) => t.objectProperty(ex, ex, false, true))\n            )\n          )\n        );\n\n        file.path.pushContainer('body', linariaExport);\n      }\n\n      log('end', '__linariaPreval has been added');\n    },\n  };\n}\n"],"mappings":"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"}