{"version":3,"file":"babel-transform.js","names":["debug","removeWithRelated","syncResolve","prepareForEvalSync","evalStage","processTemplateExpression","withLinariaMetadata","collector","babel","options","codeCache","Map","resolveCache","evalCache","name","pre","file","opts","filename","entryPoint","code","only","prepareStageResults","root","undefined","pluginOptions","every","r","metadata","evalStageResult","map","valueCache","path","traverse","Identifier","p","processor","build","doRuntimeReplacement","prevalExport","scope","getData","findParent","isExpressionStatement","visitor","post"],"sources":["../../src/plugins/babel-transform.ts"],"sourcesContent":["import type { BabelFile, PluginObj } from '@babel/core';\nimport type { NodePath } from '@babel/traverse';\n\nimport { debug } from '@linaria/logger';\nimport type { StrictOptions } from '@linaria/utils';\nimport { removeWithRelated, syncResolve } from '@linaria/utils';\n\nimport type { Core } from '../babel';\nimport type Module from '../module';\nimport { prepareForEvalSync } from '../transform-stages/1-prepare-for-eval';\nimport evalStage from '../transform-stages/2-eval';\nimport type { CodeCache, IPluginState } from '../types';\nimport processTemplateExpression from '../utils/processTemplateExpression';\nimport withLinariaMetadata from '../utils/withLinariaMetadata';\n\nexport default function collector(\n  babel: Core,\n  options: StrictOptions\n): PluginObj<IPluginState> {\n  const codeCache: CodeCache = new Map();\n  const resolveCache = new Map<string, string>();\n  const evalCache = new Map<string, Module>();\n\n  return {\n    name: '@linaria/babel/babel-transform',\n    pre(file: BabelFile) {\n      debug('babel-transform:start', file.opts.filename);\n\n      const entryPoint = {\n        name: file.opts.filename!,\n        code: file.code,\n        only: ['__linariaPreval'],\n      };\n\n      const prepareStageResults = prepareForEvalSync(\n        resolveCache,\n        codeCache,\n        syncResolve,\n        entryPoint,\n        {\n          root: file.opts.root ?? undefined,\n          pluginOptions: options,\n        }\n      );\n\n      if (\n        !prepareStageResults ||\n        prepareStageResults.every((r) => !withLinariaMetadata(r.metadata))\n      ) {\n        return;\n      }\n\n      const evalStageResult = evalStage(\n        resolveCache,\n        codeCache,\n        evalCache,\n        prepareStageResults.map((r) => r.code),\n        {\n          filename: file.opts.filename!,\n          pluginOptions: options,\n        }\n      );\n\n      if (evalStageResult === null) {\n        return;\n      }\n\n      const [valueCache] = evalStageResult;\n\n      file.path.traverse({\n        // TODO: process transformed literals\n        Identifier: (p) => {\n          processTemplateExpression(p, file.opts, options, (processor) => {\n            processor.build(valueCache);\n\n            processor.doRuntimeReplacement();\n          });\n        },\n      });\n\n      // We can remove __linariaPreval export and all related code\n      const prevalExport = (\n        file.path.scope.getData('__linariaPreval') as NodePath | undefined\n      )?.findParent((p) => p.isExpressionStatement());\n      if (prevalExport) {\n        removeWithRelated([prevalExport]);\n      }\n    },\n    visitor: {},\n    post(file: BabelFile) {\n      debug('babel-transform:end', file.opts.filename);\n    },\n  };\n}\n"],"mappings":"AAGA,SAASA,KAAT,QAAsB,iBAAtB;AAEA,SAASC,iBAAT,EAA4BC,WAA5B,QAA+C,gBAA/C;AAIA,SAASC,kBAAT,QAAmC,wCAAnC;AACA,OAAOC,SAAP,MAAsB,4BAAtB;AAEA,OAAOC,yBAAP,MAAsC,oCAAtC;AACA,OAAOC,mBAAP,MAAgC,8BAAhC;AAEA,eAAe,SAASC,SAAT,CACbC,KADa,EAEbC,OAFa,EAGY;EACzB,MAAMC,SAAoB,GAAG,IAAIC,GAAJ,EAA7B;EACA,MAAMC,YAAY,GAAG,IAAID,GAAJ,EAArB;EACA,MAAME,SAAS,GAAG,IAAIF,GAAJ,EAAlB;EAEA,OAAO;IACLG,IAAI,EAAE,gCADD;;IAELC,GAAG,CAACC,IAAD,EAAkB;MACnBhB,KAAK,CAAC,uBAAD,EAA0BgB,IAAI,CAACC,IAAL,CAAUC,QAApC,CAAL;MAEA,MAAMC,UAAU,GAAG;QACjBL,IAAI,EAAEE,IAAI,CAACC,IAAL,CAAUC,QADC;QAEjBE,IAAI,EAAEJ,IAAI,CAACI,IAFM;QAGjBC,IAAI,EAAE,CAAC,iBAAD;MAHW,CAAnB;MAMA,MAAMC,mBAAmB,GAAGnB,kBAAkB,CAC5CS,YAD4C,EAE5CF,SAF4C,EAG5CR,WAH4C,EAI5CiB,UAJ4C,EAK5C;QACEI,IAAI,EAAEP,IAAI,CAACC,IAAL,CAAUM,IAAV,IAAkBC,SAD1B;QAEEC,aAAa,EAAEhB;MAFjB,CAL4C,CAA9C;;MAWA,IACE,CAACa,mBAAD,IACAA,mBAAmB,CAACI,KAApB,CAA2BC,CAAD,IAAO,CAACrB,mBAAmB,CAACqB,CAAC,CAACC,QAAH,CAArD,CAFF,EAGE;QACA;MACD;;MAED,MAAMC,eAAe,GAAGzB,SAAS,CAC/BQ,YAD+B,EAE/BF,SAF+B,EAG/BG,SAH+B,EAI/BS,mBAAmB,CAACQ,GAApB,CAAyBH,CAAD,IAAOA,CAAC,CAACP,IAAjC,CAJ+B,EAK/B;QACEF,QAAQ,EAAEF,IAAI,CAACC,IAAL,CAAUC,QADtB;QAEEO,aAAa,EAAEhB;MAFjB,CAL+B,CAAjC;;MAWA,IAAIoB,eAAe,KAAK,IAAxB,EAA8B;QAC5B;MACD;;MAED,MAAM,CAACE,UAAD,IAAeF,eAArB;MAEAb,IAAI,CAACgB,IAAL,CAAUC,QAAV,CAAmB;QACjB;QACAC,UAAU,EAAGC,CAAD,IAAO;UACjB9B,yBAAyB,CAAC8B,CAAD,EAAInB,IAAI,CAACC,IAAT,EAAeR,OAAf,EAAyB2B,SAAD,IAAe;YAC9DA,SAAS,CAACC,KAAV,CAAgBN,UAAhB;YAEAK,SAAS,CAACE,oBAAV;UACD,CAJwB,CAAzB;QAKD;MARgB,CAAnB,EA5CmB,CAuDnB;;MACA,MAAMC,YAAY,GAChBvB,IAAI,CAACgB,IAAL,CAAUQ,KAAV,CAAgBC,OAAhB,CAAwB,iBAAxB,CADmB,EAElBC,UAFkB,CAENP,CAAD,IAAOA,CAAC,CAACQ,qBAAF,EAFA,CAArB;;MAGA,IAAIJ,YAAJ,EAAkB;QAChBtC,iBAAiB,CAAC,CAACsC,YAAD,CAAD,CAAjB;MACD;IACF,CAhEI;;IAiELK,OAAO,EAAE,EAjEJ;;IAkELC,IAAI,CAAC7B,IAAD,EAAkB;MACpBhB,KAAK,CAAC,qBAAD,EAAwBgB,IAAI,CAACC,IAAL,CAAUC,QAAlC,CAAL;IACD;;EApEI,CAAP;AAsED"}