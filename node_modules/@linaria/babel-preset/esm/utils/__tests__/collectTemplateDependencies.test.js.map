{"version":3,"file":"collectTemplateDependencies.test.js","names":["babel","parseAsync","generate","dedent","stripAnsi","extractExpression","File","go","code","parsed","filename","__filename","file","ast","path","traverse","TemplateLiteral","expressions","get","forEach","exp","isExpression","describe","it","expect","toMatchSnapshot","assertions","e","message"],"sources":["../../../src/utils/__tests__/collectTemplateDependencies.test.ts"],"sourcesContent":["import * as babel from '@babel/core';\nimport { parseAsync } from '@babel/core';\nimport generate from '@babel/generator';\nimport dedent from 'dedent';\nimport stripAnsi from 'strip-ansi';\n\nimport type { MissedBabelCoreTypes } from '../../types';\nimport { extractExpression } from '../collectTemplateDependencies';\n\nconst { File } = babel as typeof babel & MissedBabelCoreTypes;\n\nasync function go(code: string): Promise<string> {\n  const parsed = (await parseAsync(code, {\n    filename: __filename,\n  }))!;\n\n  const file = new File({ filename: __filename }, { code, ast: parsed });\n\n  file.path.traverse({\n    TemplateLiteral(path) {\n      const expressions = path.get('expressions');\n      expressions.forEach((exp) => {\n        if (exp.isExpression()) {\n          extractExpression(exp, true, false);\n        }\n      });\n    },\n  });\n\n  return generate(parsed).code;\n}\n\ndescribe('collectTemplateDependencies', () => {\n  it('hoist expressions', async () => {\n    const code = dedent`\n      import x from \"module\";\n\n      function fn() {\n        const value = 21;\n        const variable = \"test\";\n        const result = \"result\";\n        const template = tag\\`${'${value * 2}'}${'${variable}'}${'${(() => result)}'}${'${value * x}'}\\`;\n      }\n    `;\n\n    expect(await go(code)).toMatchSnapshot();\n  });\n\n  it('should hoist expressions after imports', async () => {\n    const code = dedent`\n      import { styled } from '@linaria/react';\n      import slugify from '../__fixtures__/slugify';\n\n      export const Title = styled.h1\\`\n        &:before {\n          content: \"${\"${slugify('test')}\"}\"\n        }\n      \\`;\n    `;\n\n    expect(await go(code)).toMatchSnapshot();\n  });\n\n  it('non-hoistable expression', async () => {\n    expect.assertions(1);\n\n    const code = dedent`\n      function fn(arg) {\n        {\n          const base = \"base\";\n          const variable = base + arg;\n          const template = tag\\`${'${variable}'}\\`;\n        }\n      }\n    `;\n\n    try {\n      await go(code);\n    } catch (e) {\n      expect(stripAnsi((e as { message: string }).message)).toMatchSnapshot();\n    }\n  });\n\n  it('hoist chain of statements', async () => {\n    const code = dedent`\n      import str from \"module\";\n\n      function fn() {\n        {\n          const arg = str;\n          const variable = arg + \"2\";\n          const template = tag\\`${'${variable}'}\\`;\n        }\n      }\n    `;\n\n    expect(await go(code)).toMatchSnapshot();\n  });\n\n  it('hoistExpression with destructuring', async () => {\n    const code = dedent`\n      function fn() {\n        const result = \"result\";\n        const { variable } = { variable: result };\n        const template = tag\\`${'${variable}'}\\`;\n      }\n    `;\n\n    expect(await go(code)).toMatchSnapshot();\n  });\n\n  it('hoistExpression with object', async () => {\n    const code = dedent`\n      const obj = {\n        variable: \"test\",\n      }\n\n      function fn() {\n        const template = tag\\`${'${obj.variable}'}\\`;\n      }\n    `;\n\n    expect(await go(code)).toMatchSnapshot();\n  });\n});\n"],"mappings":"AAAA,OAAO,KAAKA,KAAZ,MAAuB,aAAvB;AACA,SAASC,UAAT,QAA2B,aAA3B;AACA,OAAOC,QAAP,MAAqB,kBAArB;AACA,OAAOC,MAAP,MAAmB,QAAnB;AACA,OAAOC,SAAP,MAAsB,YAAtB;AAGA,SAASC,iBAAT,QAAkC,gCAAlC;AAEA,MAAM;EAAEC;AAAF,IAAWN,KAAjB;;AAEA,eAAeO,EAAf,CAAkBC,IAAlB,EAAiD;EAC/C,MAAMC,MAAM,GAAI,MAAMR,UAAU,CAACO,IAAD,EAAO;IACrCE,QAAQ,EAAEC;EAD2B,CAAP,CAAhC;EAIA,MAAMC,IAAI,GAAG,IAAIN,IAAJ,CAAS;IAAEI,QAAQ,EAAEC;EAAZ,CAAT,EAAmC;IAAEH,IAAF;IAAQK,GAAG,EAAEJ;EAAb,CAAnC,CAAb;EAEAG,IAAI,CAACE,IAAL,CAAUC,QAAV,CAAmB;IACjBC,eAAe,CAACF,IAAD,EAAO;MACpB,MAAMG,WAAW,GAAGH,IAAI,CAACI,GAAL,CAAS,aAAT,CAApB;MACAD,WAAW,CAACE,OAAZ,CAAqBC,GAAD,IAAS;QAC3B,IAAIA,GAAG,CAACC,YAAJ,EAAJ,EAAwB;UACtBhB,iBAAiB,CAACe,GAAD,EAAM,IAAN,EAAY,KAAZ,CAAjB;QACD;MACF,CAJD;IAKD;;EARgB,CAAnB;EAWA,OAAOlB,QAAQ,CAACO,MAAD,CAAR,CAAiBD,IAAxB;AACD;;AAEDc,QAAQ,CAAC,6BAAD,EAAgC,MAAM;EAC5CC,EAAE,CAAC,mBAAD,EAAsB,YAAY;IAClC,MAAMf,IAAI,GAAGL,MAAO;AACxB;AACA;AACA;AACA;AACA;AACA;AACA,gCAAgC,cAAe,GAAE,aAAc,GAAE,mBAAoB,GAAE,cAAe;AACtG;AACA,KATI;IAWAqB,MAAM,CAAC,MAAMjB,EAAE,CAACC,IAAD,CAAT,CAAN,CAAuBiB,eAAvB;EACD,CAbC,CAAF;EAeAF,EAAE,CAAC,wCAAD,EAA2C,YAAY;IACvD,MAAMf,IAAI,GAAGL,MAAO;AACxB;AACA;AACA;AACA;AACA;AACA,sBAAsB,oBAAqB;AAC3C;AACA;AACA,KATI;IAWAqB,MAAM,CAAC,MAAMjB,EAAE,CAACC,IAAD,CAAT,CAAN,CAAuBiB,eAAvB;EACD,CAbC,CAAF;EAeAF,EAAE,CAAC,0BAAD,EAA6B,YAAY;IACzCC,MAAM,CAACE,UAAP,CAAkB,CAAlB;IAEA,MAAMlB,IAAI,GAAGL,MAAO;AACxB;AACA;AACA;AACA;AACA,kCAAkC,aAAc;AAChD;AACA;AACA,KARI;;IAUA,IAAI;MACF,MAAMI,EAAE,CAACC,IAAD,CAAR;IACD,CAFD,CAEE,OAAOmB,CAAP,EAAU;MACVH,MAAM,CAACpB,SAAS,CAAEuB,CAAD,CAA2BC,OAA5B,CAAV,CAAN,CAAsDH,eAAtD;IACD;EACF,CAlBC,CAAF;EAoBAF,EAAE,CAAC,2BAAD,EAA8B,YAAY;IAC1C,MAAMf,IAAI,GAAGL,MAAO;AACxB;AACA;AACA;AACA;AACA;AACA;AACA,kCAAkC,aAAc;AAChD;AACA;AACA,KAVI;IAYAqB,MAAM,CAAC,MAAMjB,EAAE,CAACC,IAAD,CAAT,CAAN,CAAuBiB,eAAvB;EACD,CAdC,CAAF;EAgBAF,EAAE,CAAC,oCAAD,EAAuC,YAAY;IACnD,MAAMf,IAAI,GAAGL,MAAO;AACxB;AACA;AACA;AACA,gCAAgC,aAAc;AAC9C;AACA,KANI;IAQAqB,MAAM,CAAC,MAAMjB,EAAE,CAACC,IAAD,CAAT,CAAN,CAAuBiB,eAAvB;EACD,CAVC,CAAF;EAYAF,EAAE,CAAC,6BAAD,EAAgC,YAAY;IAC5C,MAAMf,IAAI,GAAGL,MAAO;AACxB;AACA;AACA;AACA;AACA;AACA,gCAAgC,iBAAkB;AAClD;AACA,KARI;IAUAqB,MAAM,CAAC,MAAMjB,EAAE,CAACC,IAAD,CAAT,CAAN,CAAuBiB,eAAvB;EACD,CAZC,CAAF;AAaD,CA5FO,CAAR"}