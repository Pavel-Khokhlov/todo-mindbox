{"version":3,"file":"getTagProcessor.js","names":["readFileSync","basename","dirname","join","types","t","addNamed","findUp","BaseProcessor","collectExportsAndImports","explicitImport","isNotNull","mutate","collectTemplateDependencies","extractExpression","getSource","last","arr","length","zip","arr1","arr2","result","i","push","buildCodeFrameError","path","message","Error","findPackageJSON","pkgName","filename","pkgPath","require","resolve","paths","sync","cwd","er","code","undefined","definedTagsCache","Map","getDefinedTagsFromPackage","has","get","packageJSONPath","packageDir","packageJSON","JSON","parse","definedTags","linaria","tags","normalizedTags","Object","entries","reduce","acc","key","value","startsWith","set","isValidProcessorClass","module","constructor","getProcessorFromPackage","packageName","tagName","processorPath","Processor","default","getProcessorFromFile","getProcessorForIdentifier","imports","options","pathBinding","scope","getBinding","node","name","tagResolver","relatedImports","map","local","isIdentifier","isDescendant","binding","filter","isExpression","tagPath","imp","p","source","imported","processor","find","proc","getBuilderForIdentifier","params","prev","current","parentPath","isSequenceExpression","expressions","isCallExpression","callee","args","cookedArgs","arg","buildError","bind","type","extracted","evaluate","isMemberExpression","object","property","computed","isStringLiteral","isTaggedTemplateExpression","tag","quasis","expressionValues","replacer","replacement","isPure","replaceWith","addComment","astService","addNamedImport","importedSource","loc","getDisplayName","idx","fileContext","displayName","parent","findParent","isObjectProperty","isJSXOpeningElement","isVariableDeclarator","toString","keyPath","isJSXIdentifier","id","test","replace","isTagReferenced","isReferenced","referencePaths","counters","WeakMap","getNextIndex","state","counter","cache","getTagProcessor","root","getProgramParent","builder","e"],"sources":["../../src/utils/getTagProcessor.ts"],"sourcesContent":["import { readFileSync } from 'fs';\nimport { basename, dirname, join } from 'path';\n\nimport { types as t } from '@babel/core';\nimport { addNamed } from '@babel/helper-module-imports';\nimport type { NodePath } from '@babel/traverse';\nimport type {\n  Expression,\n  SourceLocation,\n  Identifier,\n  MemberExpression,\n} from '@babel/types';\nimport findUp from 'find-up';\n\nimport { BaseProcessor } from '@linaria/tags';\nimport type { Param, Params, IFileContext } from '@linaria/tags';\nimport type { IImport, StrictOptions } from '@linaria/utils';\nimport {\n  collectExportsAndImports,\n  explicitImport,\n  isNotNull,\n  mutate,\n} from '@linaria/utils';\n\nimport collectTemplateDependencies, {\n  extractExpression,\n} from './collectTemplateDependencies';\nimport getSource from './getSource';\n\ntype BuilderArgs = ConstructorParameters<typeof BaseProcessor> extends [\n  Params,\n  typeof t,\n  SourceLocation | null,\n  (replacement: Expression, isPure: boolean) => void,\n  ...infer T\n]\n  ? T\n  : never;\n\ntype Builder = (...args: BuilderArgs) => BaseProcessor;\n\ntype ProcessorClass = new (\n  ...args: ConstructorParameters<typeof BaseProcessor>\n) => BaseProcessor;\n\nconst last = <T>(arr: T[]): T | undefined => arr[arr.length - 1];\n\nfunction zip<T1, T2>(arr1: T1[], arr2: T2[]) {\n  const result: (T1 | T2)[] = [];\n  for (let i = 0; i < arr1.length; i++) {\n    result.push(arr1[i]);\n    if (arr2[i]) result.push(arr2[i]);\n  }\n\n  return result;\n}\n\nfunction buildCodeFrameError(path: NodePath, message: string): Error {\n  try {\n    return path.buildCodeFrameError(message);\n  } catch {\n    return new Error(message);\n  }\n}\n\nfunction findPackageJSON(pkgName: string, filename: string | null | undefined) {\n  try {\n    const pkgPath = require.resolve(\n      pkgName,\n      filename ? { paths: [dirname(filename)] } : {}\n    );\n    return findUp.sync('package.json', { cwd: pkgPath });\n  } catch (er: unknown) {\n    if (\n      typeof er === 'object' &&\n      er !== null &&\n      (er as { code?: unknown }).code === 'MODULE_NOT_FOUND'\n    ) {\n      return undefined;\n    }\n\n    throw er;\n  }\n}\n\nconst definedTagsCache = new Map<string, Record<string, string> | undefined>();\nconst getDefinedTagsFromPackage = (\n  pkgName: string,\n  filename: string | null | undefined\n): Record<string, string> | undefined => {\n  if (definedTagsCache.has(pkgName)) {\n    return definedTagsCache.get(pkgName);\n  }\n\n  const packageJSONPath = findPackageJSON(pkgName, filename);\n  if (!packageJSONPath) {\n    return undefined;\n  }\n\n  const packageDir = dirname(packageJSONPath);\n  const packageJSON = JSON.parse(readFileSync(packageJSONPath, 'utf8'));\n  const definedTags: Record<string, string> | undefined =\n    packageJSON.linaria?.tags;\n\n  const normalizedTags = definedTags\n    ? Object.entries(definedTags).reduce(\n        (acc, [key, value]) => ({\n          ...acc,\n          [key]: value.startsWith('.')\n            ? join(packageDir, value)\n            : require.resolve(value, { paths: [packageDir] }),\n        }),\n        {} as Record<string, string>\n      )\n    : undefined;\n\n  definedTagsCache.set(pkgName, normalizedTags);\n\n  return normalizedTags;\n};\n\nfunction isValidProcessorClass(module: unknown): module is ProcessorClass {\n  return module instanceof BaseProcessor.constructor;\n}\n\nfunction getProcessorFromPackage(\n  packageName: string,\n  tagName: string,\n  filename: string | null | undefined\n): ProcessorClass | null {\n  const definedTags = getDefinedTagsFromPackage(packageName, filename);\n  const processorPath = definedTags?.[tagName];\n  if (!processorPath) {\n    return null;\n  }\n\n  const Processor = require(processorPath).default;\n  if (!isValidProcessorClass(Processor)) {\n    return null;\n  }\n\n  return Processor;\n}\n\nfunction getProcessorFromFile(processorPath: string): ProcessorClass | null {\n  const Processor = require(processorPath).default;\n  if (!isValidProcessorClass(Processor)) {\n    return null;\n  }\n\n  return Processor;\n}\n\nfunction getProcessorForIdentifier(\n  path: NodePath<Identifier>,\n  imports: IImport[],\n  filename: string | null | undefined,\n  options: Pick<\n    StrictOptions,\n    'classNameSlug' | 'displayName' | 'evaluate' | 'tagResolver'\n  >\n): [ProcessorClass, NodePath<Identifier | MemberExpression>] | [null, null] {\n  const pathBinding = path.scope.getBinding(path.node.name);\n  if (!pathBinding) {\n    // It's not a binding, so it's not a tag\n    return [null, null];\n  }\n\n  const tagResolver = options.tagResolver ?? (() => null);\n\n  // FIXME: can be simplified\n  const relatedImports = imports\n    .map(\n      (i): [IImport, NodePath<Identifier | MemberExpression> | null] | null => {\n        const { local } = i;\n\n        if (local === path) {\n          return [i, null];\n        }\n\n        if (!local.isIdentifier()) {\n          if (path.isDescendant(local)) {\n            return [i, local];\n          }\n\n          return null;\n        }\n\n        const binding = local.scope.getBinding(local.node.name);\n        if (pathBinding === binding) {\n          return [i, path];\n        }\n\n        return null;\n      }\n    )\n    .filter(isNotNull)\n    .filter((i) => i[1] === null || i[1].isExpression());\n\n  if (relatedImports.length === 0) {\n    return [null, null];\n  }\n\n  const [Processor = null, tagPath = null] =\n    relatedImports\n      .map(\n        ([imp, p]): [\n          ProcessorClass | null,\n          NodePath<Identifier | MemberExpression> | null\n        ] => {\n          const source = tagResolver(imp.source, imp.imported);\n          const processor = source\n            ? getProcessorFromFile(source)\n            : getProcessorFromPackage(imp.source, imp.imported, filename);\n          return [processor, p];\n        }\n      )\n      .find(([proc]) => proc) ?? [];\n\n  return Processor === null || tagPath === null\n    ? [null, null]\n    : [Processor, tagPath];\n}\n\nfunction getBuilderForIdentifier(\n  path: NodePath<Identifier>,\n  imports: IImport[],\n  filename: string | null | undefined,\n  options: Pick<\n    StrictOptions,\n    'classNameSlug' | 'displayName' | 'evaluate' | 'tagResolver'\n  >\n): Builder | null {\n  const [Processor, tagPath] = getProcessorForIdentifier(\n    path,\n    imports,\n    filename,\n    options\n  );\n\n  if (!Processor || !tagPath) {\n    return null;\n  }\n\n  const params: Param[] = [['tag', tagPath.node]];\n  let prev: NodePath = tagPath;\n  let current: NodePath | null = tagPath.parentPath;\n  while (current && current !== path) {\n    if (\n      current?.isSequenceExpression() &&\n      last(current.node.expressions) === prev.node\n    ) {\n      prev = current;\n      current = current.parentPath;\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    if (current?.isCallExpression({ callee: prev.node })) {\n      const args = current.get('arguments');\n      const cookedArgs = args\n        .map((arg) => {\n          const buildError = arg.buildCodeFrameError.bind(arg);\n          if (!arg.isExpression()) {\n            throw buildError(`Unexpected type of an argument ${arg.type}`);\n          }\n          const source = getSource(arg);\n          const extracted = extractExpression(arg, options.evaluate);\n          return { ...extracted, source, buildCodeFrameError: buildError };\n        })\n        .filter(isNotNull);\n\n      params.push(['call', ...cookedArgs]);\n      prev = current;\n      current = current.parentPath;\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    if (current?.isMemberExpression({ object: prev.node })) {\n      const property = current.get('property');\n      if (property.isIdentifier() && !current.node.computed) {\n        params.push(['member', property.node.name]);\n      } else if (property.isStringLiteral()) {\n        params.push(['member', property.node.value]);\n      } else {\n        throw property.buildCodeFrameError(`Unexpected type of a property`);\n      }\n\n      prev = current;\n      current = current.parentPath;\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    if (current?.isTaggedTemplateExpression({ tag: prev.node })) {\n      const [quasis, expressionValues] = collectTemplateDependencies(\n        current,\n        options.evaluate\n      );\n      params.push(['template', zip(quasis, expressionValues)]);\n\n      prev = current;\n      current = current.parentPath;\n      // eslint-disable-next-line no-continue\n      continue;\n    }\n\n    break;\n  }\n\n  const replacer = (replacement: Expression, isPure: boolean) => {\n    mutate(prev, (p) => {\n      p.replaceWith(replacement);\n      if (isPure) {\n        p.addComment('leading', '#__PURE__');\n      }\n    });\n  };\n\n  const astService = {\n    ...t,\n    addNamedImport: (name: string, importedSource: string) =>\n      addNamed(path, name, importedSource),\n  };\n\n  return (...args: BuilderArgs) =>\n    new Processor(\n      params,\n      astService,\n      tagPath.node.loc ?? null,\n      replacer,\n      ...args\n    );\n}\n\nfunction getDisplayName(\n  path: NodePath<Identifier>,\n  idx: number,\n  fileContext: IFileContext\n): string {\n  let displayName: string | undefined;\n\n  const parent = path.findParent(\n    (p) =>\n      p.isObjectProperty() ||\n      p.isJSXOpeningElement() ||\n      p.isVariableDeclarator()\n  );\n\n  if (parent) {\n    if (parent.isObjectProperty()) {\n      if ('name' in parent.node.key) {\n        displayName = parent.node.key.name;\n      } else if ('value' in parent.node.key) {\n        displayName = parent.node.key.value.toString();\n      } else {\n        const keyPath = parent.get('key');\n        displayName = getSource(keyPath);\n      }\n    } else if (parent.isJSXOpeningElement()) {\n      const name = parent.get('name');\n      if (name.isJSXIdentifier()) {\n        displayName = name.node.name;\n      }\n    } else if (parent.isVariableDeclarator()) {\n      const id = parent.get('id');\n      if (id.isIdentifier()) {\n        displayName = id.node.name;\n      }\n    }\n  }\n\n  if (!displayName) {\n    const filename = fileContext.filename ?? 'unknown';\n    // Try to derive the path from the filename\n    displayName = basename(filename);\n\n    if (/^index\\.[a-z\\d]+$/.test(displayName)) {\n      // If the file name is 'index', better to get name from parent folder\n      displayName = basename(dirname(filename));\n    }\n\n    // Remove the file extension\n    displayName = displayName.replace(/\\.[a-z\\d]+$/, '');\n\n    if (displayName) {\n      displayName += idx;\n    } else {\n      throw new Error(\n        \"Couldn't determine a name for the component. Ensure that it's either:\\n\" +\n          '- Assigned to a variable\\n' +\n          '- Is an object property\\n' +\n          '- Is a prop in a JSX element\\n'\n      );\n    }\n  }\n\n  return displayName;\n}\n\nfunction isTagReferenced(path: NodePath): boolean {\n  // Check if the variable is referenced anywhere for basic DCE\n  // Only works when it's assigned to a variable\n  let isReferenced = true;\n\n  const parent = path.findParent(\n    (p) =>\n      p.isObjectProperty() ||\n      p.isJSXOpeningElement() ||\n      p.isVariableDeclarator()\n  );\n\n  if (parent) {\n    if (parent.isVariableDeclarator()) {\n      const id = parent.get('id');\n      // FIXME: replace with id.isReferencedIdentifier()\n      if (id.isIdentifier()) {\n        const { referencePaths } = path.scope.getBinding(id.node.name) || {\n          referencePaths: [],\n        };\n\n        isReferenced = referencePaths.length !== 0;\n      }\n    }\n  }\n\n  return isReferenced;\n}\n\nconst counters = new WeakMap<IFileContext, number>();\nconst getNextIndex = (state: IFileContext) => {\n  const counter = counters.get(state) ?? 0;\n  counters.set(state, counter + 1);\n  return counter;\n};\n\nconst cache = new WeakMap<Identifier, BaseProcessor | null>();\n\nexport default function getTagProcessor(\n  path: NodePath<Identifier>,\n  fileContext: IFileContext,\n  options: Pick<\n    StrictOptions,\n    'classNameSlug' | 'displayName' | 'evaluate' | 'tagResolver'\n  >\n): BaseProcessor | null {\n  if (!cache.has(path.node)) {\n    const root = path.scope.getProgramParent().path;\n    const { imports } = collectExportsAndImports(root, fileContext.filename);\n    try {\n      const builder = getBuilderForIdentifier(\n        path,\n        imports.filter(explicitImport),\n        fileContext.filename,\n        options\n      );\n      if (builder) {\n        // Increment the index of the style we're processing\n        // This is used for slug generation to prevent collision\n        // Also used for display name if it couldn't be determined\n        const idx = getNextIndex(fileContext);\n\n        const displayName = getDisplayName(path, idx, fileContext);\n\n        const processor = builder(\n          displayName,\n          isTagReferenced(path),\n          idx,\n          options,\n          fileContext\n        );\n\n        cache.set(path.node, processor);\n      } else {\n        cache.set(path.node, null);\n      }\n    } catch (e) {\n      if (e instanceof Error) {\n        throw buildCodeFrameError(path, e.message);\n      }\n\n      throw e;\n    }\n  }\n\n  return cache.get(path.node) ?? null;\n}\n"],"mappings":"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"}