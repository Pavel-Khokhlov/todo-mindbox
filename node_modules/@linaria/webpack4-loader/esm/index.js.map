{"version":3,"file":"index.js","names":["path","loaderUtils","transform","debug","getCacheInstance","castSourceMap","sourceMap","version","toString","undefined","outputCssLoader","require","resolve","webpack4Loader","content","inputSourceMap","async","resourcePath","preprocessor","extension","cacheProvider","rest","getOptions","outputFileName","replace","asyncResolve","token","importer","context","isAbsolute","dirname","join","process","cwd","Promise","reject","err","result","addDependency","Error","filename","relative","pluginOptions","then","cssText","Buffer","from","cssSourceMapText","all","dependencies","map","dep","cacheInstance","set","request","encodeURIComponent","stringifiedRequest","stringifyRequest","callback","code","catch"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Webpack loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\n\nimport loaderUtils from 'loader-utils';\nimport type { RawSourceMap } from 'source-map';\n\nimport type { Result } from '@linaria/babel-preset';\nimport { transform } from '@linaria/babel-preset';\nimport { debug } from '@linaria/logger';\n\nimport { getCacheInstance } from './cache';\n\ntype LoaderContext = Parameters<typeof loaderUtils.getOptions>[0];\n\nconst castSourceMap = <T extends { version: number } | { version: string }>(\n  sourceMap: T | null | undefined\n) =>\n  sourceMap\n    ? {\n        ...sourceMap,\n        version: sourceMap.version.toString(),\n      }\n    : undefined;\n\nconst outputCssLoader = require.resolve('./outputCssLoader');\n\nexport default function webpack4Loader(\n  this: LoaderContext,\n  content: string,\n  inputSourceMap: RawSourceMap | null\n) {\n  // tell Webpack this loader is async\n  this.async();\n\n  debug('loader', this.resourcePath);\n\n  const {\n    sourceMap = undefined,\n    preprocessor = undefined,\n    extension = '.linaria.css',\n    cacheProvider,\n    ...rest\n  } = loaderUtils.getOptions(this) || {};\n\n  const outputFileName = this.resourcePath.replace(/\\.[^.]+$/, extension);\n\n  const asyncResolve = (token: string, importer: string): Promise<string> => {\n    const context = path.isAbsolute(importer)\n      ? path.dirname(importer)\n      : path.join(process.cwd(), path.dirname(importer));\n    return new Promise((resolve, reject) => {\n      this.resolve(context, token, (err, result) => {\n        if (err) {\n          reject(err);\n        } else if (result) {\n          this.addDependency(result);\n          resolve(result);\n        } else {\n          reject(new Error(`Cannot resolve ${token}`));\n        }\n      });\n    });\n  };\n\n  transform(\n    content.toString(),\n    {\n      filename: path.relative(process.cwd(), this.resourcePath),\n      inputSourceMap: inputSourceMap ?? undefined,\n      pluginOptions: rest,\n      preprocessor,\n    },\n    asyncResolve\n  ).then(\n    async (result: Result) => {\n      if (result.cssText) {\n        let { cssText } = result;\n\n        if (sourceMap) {\n          cssText += `/*# sourceMappingURL=data:application/json;base64,${Buffer.from(\n            result.cssSourceMapText || ''\n          ).toString('base64')}*/`;\n        }\n\n        await Promise.all(\n          result.dependencies?.map((dep) =>\n            asyncResolve(dep, this.resourcePath)\n          ) ?? []\n        );\n\n        getCacheInstance(cacheProvider)\n          .then((cacheInstance) =>\n            cacheInstance.set(this.resourcePath, cssText)\n          )\n          .then(() => {\n            const request = `${outputFileName}!=!${outputCssLoader}?cacheProvider=${encodeURIComponent(\n              cacheProvider ?? ''\n            )}!${this.resourcePath}`;\n            const stringifiedRequest = loaderUtils.stringifyRequest(\n              this,\n              request\n            );\n\n            return this.callback(\n              null,\n              `${result.code}\\n\\nrequire(${stringifiedRequest});`,\n              castSourceMap(result.sourceMap)\n            );\n          })\n          .catch((err: Error) => this.callback(err));\n        return;\n      }\n\n      this.callback(null, result.code, castSourceMap(result.sourceMap));\n    },\n    (err: Error) => this.callback(err)\n  );\n}\n"],"mappings":"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"}