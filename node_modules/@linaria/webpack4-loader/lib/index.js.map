{"version":3,"file":"index.js","names":["castSourceMap","sourceMap","version","toString","undefined","outputCssLoader","require","resolve","webpack4Loader","content","inputSourceMap","async","debug","resourcePath","preprocessor","extension","cacheProvider","rest","loaderUtils","getOptions","outputFileName","replace","asyncResolve","token","importer","context","path","isAbsolute","dirname","join","process","cwd","Promise","reject","err","result","addDependency","Error","transform","filename","relative","pluginOptions","then","cssText","Buffer","from","cssSourceMapText","all","dependencies","map","dep","getCacheInstance","cacheInstance","set","request","encodeURIComponent","stringifiedRequest","stringifyRequest","callback","code","catch"],"sources":["../src/index.ts"],"sourcesContent":["/**\n * This file contains a Webpack loader for Linaria.\n * It uses the transform.ts function to generate class names from source code,\n * returns transformed code without template literals and attaches generated source maps\n */\n\nimport path from 'path';\n\nimport loaderUtils from 'loader-utils';\nimport type { RawSourceMap } from 'source-map';\n\nimport type { Result } from '@linaria/babel-preset';\nimport { transform } from '@linaria/babel-preset';\nimport { debug } from '@linaria/logger';\n\nimport { getCacheInstance } from './cache';\n\ntype LoaderContext = Parameters<typeof loaderUtils.getOptions>[0];\n\nconst castSourceMap = <T extends { version: number } | { version: string }>(\n  sourceMap: T | null | undefined\n) =>\n  sourceMap\n    ? {\n        ...sourceMap,\n        version: sourceMap.version.toString(),\n      }\n    : undefined;\n\nconst outputCssLoader = require.resolve('./outputCssLoader');\n\nexport default function webpack4Loader(\n  this: LoaderContext,\n  content: string,\n  inputSourceMap: RawSourceMap | null\n) {\n  // tell Webpack this loader is async\n  this.async();\n\n  debug('loader', this.resourcePath);\n\n  const {\n    sourceMap = undefined,\n    preprocessor = undefined,\n    extension = '.linaria.css',\n    cacheProvider,\n    ...rest\n  } = loaderUtils.getOptions(this) || {};\n\n  const outputFileName = this.resourcePath.replace(/\\.[^.]+$/, extension);\n\n  const asyncResolve = (token: string, importer: string): Promise<string> => {\n    const context = path.isAbsolute(importer)\n      ? path.dirname(importer)\n      : path.join(process.cwd(), path.dirname(importer));\n    return new Promise((resolve, reject) => {\n      this.resolve(context, token, (err, result) => {\n        if (err) {\n          reject(err);\n        } else if (result) {\n          this.addDependency(result);\n          resolve(result);\n        } else {\n          reject(new Error(`Cannot resolve ${token}`));\n        }\n      });\n    });\n  };\n\n  transform(\n    content.toString(),\n    {\n      filename: path.relative(process.cwd(), this.resourcePath),\n      inputSourceMap: inputSourceMap ?? undefined,\n      pluginOptions: rest,\n      preprocessor,\n    },\n    asyncResolve\n  ).then(\n    async (result: Result) => {\n      if (result.cssText) {\n        let { cssText } = result;\n\n        if (sourceMap) {\n          cssText += `/*# sourceMappingURL=data:application/json;base64,${Buffer.from(\n            result.cssSourceMapText || ''\n          ).toString('base64')}*/`;\n        }\n\n        await Promise.all(\n          result.dependencies?.map((dep) =>\n            asyncResolve(dep, this.resourcePath)\n          ) ?? []\n        );\n\n        getCacheInstance(cacheProvider)\n          .then((cacheInstance) =>\n            cacheInstance.set(this.resourcePath, cssText)\n          )\n          .then(() => {\n            const request = `${outputFileName}!=!${outputCssLoader}?cacheProvider=${encodeURIComponent(\n              cacheProvider ?? ''\n            )}!${this.resourcePath}`;\n            const stringifiedRequest = loaderUtils.stringifyRequest(\n              this,\n              request\n            );\n\n            return this.callback(\n              null,\n              `${result.code}\\n\\nrequire(${stringifiedRequest});`,\n              castSourceMap(result.sourceMap)\n            );\n          })\n          .catch((err: Error) => this.callback(err));\n        return;\n      }\n\n      this.callback(null, result.code, castSourceMap(result.sourceMap));\n    },\n    (err: Error) => this.callback(err)\n  );\n}\n"],"mappings":"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"}